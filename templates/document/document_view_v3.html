
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <meta name="csrf_token" content="{{ csrf_token }}">
        <meta name="doc_id" content="{{ Doc.id }}">
        <title>{{ Doc.name }}</title>
        {% load static %}
        <script src="{% static 'js/jquery.min.js' %}"></script>
        <link rel="stylesheet" href="{% static 'css/select2.min.css' %}">
        <script src="{% static 'js/select2.min.js' %}"></script>
        <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
        <script src="{% static 'js/bootstrap.min.js' %}"></script>
        <link rel="stylesheet" href="{% static 'css/fontawesome.css' %}">
        <link rel="stylesheet" href="{% static 'css/solid.css' %}">
        <link rel="stylesheet" href="{% static 'css/interFonts.css' %}">
        
        <link rel="stylesheet" type="text/css" href="{% static 'css/main/index.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/main/document_view_st.css' %}">
    </head>
    <body>
            <div class="context-menu" id="context_menu">
                <div class="list-group">
                    <a class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#groupRadioModal" id="btnRadioGroup">Объединить в альтернативу</a>
                    <a class="list-group-item list-group-item-action" id="btnDependence" onclick="goToDependence();">Просмотр зависимостей</a>
                    <hr/>
                    <div id="advContextElement">
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('nomn', 'ChangeCattle')">В именительный</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('gent', 'ChangeCattle')">В родительный</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('datv', 'ChangeCattle')">В дательный</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('accs', 'ChangeCattle')">В винительный</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('ablt', 'ChangeCattle')">В творительный</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('loct', 'ChangeCattle')">В предложный</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('delFilters', 'ChangeCattle')">Убрать склонение</a>
                        <hr/>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('Upper', 'ChangeCase')">Написать заглавными</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('Lower', 'ChangeCase')">Написать строчными</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('delFilters', 'ChangeCase')">Убрать фильтр</a>
                        <hr/>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('True', 'Raskrit')">Раскрыть</a>
                        <a class="list-group-item list-group-item-action" onclick="ContextFilterClicked('delFilters', 'Raskrit')">Убрать фильтр</a>
                    </div>
                    <!-- <a class="list-group-item list-group-item-action" onclick="OpenEventModal(event);">Зависимости</a> -->
                </div>
            </div>
            <div id="TopMenu">
                <div id="TopHeader">
                    <div id="buttonBackContainer">
                        <div>
                            <a type="button" href="{% url 'home' %}"><i class="fa-solid fa-arrow-left"></i></a>
                        </div>
                    </div>
                    <div id="DocMenuContainer">
                        <div id="DocNameContainer">
                            <div id="doc_name_container">
                                <span id="doc_name" contenteditable="true">{{ Doc.name }}</span>
                            </div>
                            <div id="save_complete">Сохранено</div>
                        </div>
                        <div id="TopNavigator">
                            <nav id="header_navigation">
                                <a class="me-3 py-2 text-dark text-decoration-none" >Файл</a>
                                <a class="me-3 py-2 text-dark text-decoration-none" >Редактировать</a>
                                <a class="me-3 py-2 text-dark text-decoration-none" >Вставка</a>
                                <a class="me-3 py-2 text-dark text-decoration-none" >Шаблоны</a>
                            </nav>
                        </div>
                    </div>
                    <div id="profile_menu">
                        {% if user.is_authenticated %}
                            <a href="/accounts/profile/{{ user.id }}" class="btn btn-labeled">{{ profile }}</a>
                            <img id="img_profile" src="{% if profile.profile_pic %}{{ profile.profile_pic.url }}{% endif %}">
                            <!-- <a href="/accounts/logout/" class="btn btn-labeled"><i class="fa-solid fa-right-from-bracket" style="color:red"></i></a>
                            -->
                        {% else %}
                            <a href="/accounts/login/" class="btn btn-labeled"><i class="fa-solid fa-door-open"></i></a>
                        {% endif %}
                    </div>
                </div>
             
                <div id="menu">
                    <div id="instruments_menu">
                        <a type="submit" class="btn btn-labeled" id="updateButton"><i class="fa-solid fa-floppy-disk"></i></a>
                        <a onclick="UpdateFile(true);" target="_blank" class="btn btn-labeled" id="uploadButton"><i class="fa-solid fa-download"></i></a>
                    </div>
                    <div class="vr"></div>
                    
                    <select class="form-select" id="font_select" aria-label=".form-select пример" onchange="FontChanged()">
                        {% for font in fonts %}
                            <option style='font-family: {{ font }};' value="{{ font }}">{{ font }}</option>
                        {% endfor %}
                    </select>
                    <div class="vr"></div>
                    <i class="fa-solid fa-highlighter me-2 ms-2"></i>
                    <input type="color" list="redColors" id="colorsBackgroundRun" onchange="backgroundColorChanged()" value="#FFFFFF"/>
                    <datalist id="redColors">
                        <option value="#FFFFFF"></option>
                        <option value="#FFFF00"></option>
                        <option value="#000000"></option>
                        <option value="#0000FF"></option>
                        <option value="#00FFFF"></option>
                        <option value="#008000"></option>
                        <option value="#FF00FF"></option>
                        <option value="#FF0000"></option>
                        <option value="#FFFFFF"></option>
                        <option value="#000080"></option>
                        <option value="#008080"></option>
                        <option value="#008000"></option>
                        <option value="#800080"></option>
                        <option value="#800000"></option>
                        <option value="#808000"></option>
                        <option value="#808080"></option>
                        <option value="#C0C0C0"></option>
                    </datalist>
                    <div class="vr"></div>
                    <div class="inputNumber">
                        <div class="inputNumber">
                            <a class="btn btn-labeled inputButton" onclick="this.nextElementSibling.stepDown(); this.nextElementSibling.onchange();"><i class="fa-solid fa-minus fa-sm"></i></a>
                            <input class="inputNumberMenu" type="number" onchange="SizeChanged()" id="fontSizeElement" value="14"/>
                            <a class="btn btn-labeled inputButton" onclick="this.previousElementSibling.stepUp(); this.previousElementSibling.onchange();"><i class="fa-solid fa-plus fa-sm" ></i></a>
                        </div>
                    </div>
                    <div class="vr"></div>
                        <input type="checkbox" class="btn-check" id="btn_check_bold" autocomplete="off" onchange="SetBold()">
                        <label class="btn btn-labeled" for="btn_check_bold"><i class="fa-solid fa-bold"></i></label>
                        
                        <input type="checkbox" class="btn-check" id="btn_check_italic" autocomplete="off" onchange="SetItalic()">
                        <label class="btn btn-labeled" for="btn_check_italic"><i class="fa-solid fa-italic"></i></label>
                        
                        <input type="checkbox" class="btn-check" id="btn_check_underline" autocomplete="off" onchange="SetUnderline()">
                        <label class="btn btn-labeled" for="btn_check_underline"><i class="fa-solid fa-underline"></i></label>
                    <div class="vr"></div>
                    <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                        <input type="radio" class="btn-check" name="btnradio" id="leftAlign" onclick="OnAlignButtonClick(this)" autocomplete="off" checked>
                        <label class="btn" for="leftAlign"><i class="fa-solid fa-align-left"></i></label>
            
                        <input type="radio" class="btn-check" name="btnradio" id="centerAlign" onclick="OnAlignButtonClick(this)" autocomplete="off">
                        <label class="btn" for="centerAlign"><i class="fa-solid fa-align-center"></i></label>
            
                        <input type="radio" class="btn-check" name="btnradio" id="rightAlign" onclick="OnAlignButtonClick(this)" autocomplete="off">
                        <label class="btn" for="rightAlign"><i class="fa-solid fa-align-right"></i></label>
            
                        <input type="radio" class="btn-check" name="btnradio" id="bothAlign" onclick="OnAlignButtonClick(this)" autocomplete="off">
                        <label class="btn" for="bothAlign"><i class="fa-solid fa-align-justify"></i></label>
                    </div>
                    <div class="vr"></div>
                    <div class="labeled_input">
                        <label style="margin-right: 10px;"><i class="fa-solid fa-indent"></i></label>
                        <div class="inputNumber">
                            <a class="btn btn-labeled inputButton" onclick="this.nextElementSibling.stepDown(); this.nextElementSibling.onchange();"><i class="fa-solid fa-minus fa-sm"></i></a>
                            <input class="inputNumberMenu" type="number" onchange="IndentChanged()" id="IndentElement" value="0" step="0.1"/>
                            <a class="btn btn-labeled inputButton" onclick="this.previousElementSibling.stepUp(); this.previousElementSibling.onchange();"><i class="fa-solid fa-plus fa-sm" ></i></a>
                        </div>
                    </div>
                    <div class="vr"></div>
                    <div class="labeled_input">
                        <label style="margin-right: 10px;"><i class="fa-solid fa-arrows-left-right-to-line fa-rotate-90"></i></label>
                        <div class="inputNumber">
                            <a class="btn btn-labeled inputButton" onclick="this.nextElementSibling.stepDown(); this.nextElementSibling.onchange();"><i class="fa-solid fa-minus fa-sm"></i></a>
                            <input class="inputNumberMenu" type="number" onchange="IntervalChanged()" id="IntervalElement" value="1" step="0.1"/>
                            <a class="btn btn-labeled inputButton" onclick="this.previousElementSibling.stepUp(); this.previousElementSibling.onchange();"><i class="fa-solid fa-plus fa-sm" ></i></a>
                        </div>
                    </div>
                    <div class="vr"></div>
                    <input type="checkbox" class="btn-check" id="btn_check_nothidden" autocomplete="off" onchange="SetNotHidden();">
                    <label class="btn btn-labeled" for="btn_check_nothidden"><i class="fa-solid fa-eye-low-vision"></i></label>
                    <div class="vr"></div>
                    <!-- <a class="btn btn-labeled" onclick="filterManager.acceptAllFilters();">Применить фильтры</a>
                    <div class="vr"></div>
                    <a class="btn btn-labeled" onclick="eventManager.dispatchNotCalledEvent();">Запустить зависимости</a>
                    <div class="vr"></div> -->
                    <div class="dropdown">
                        <a class="btn btn-labeled" id="btnRadioInstruments" type="button" data-bs-toggle="dropdown" aria-expanded="false"></a>
                        <ul class="dropdownRadioMenu dropdown-menu" aria-labelledby="btnRadioInstruments">
                            <li class="dropdownRadioGroup" onclick="radioGroupClickInstrument(event)" data-idRadioGroup="radioGroup-1" type="button"><a class="dropdown-item"  style="background-color:#ffffff"></a><span>Без альтернативы</span></li>
                        </ul>
                    </div>
                </div>
                <div id="filters_menu">
                    <span style="margin-right: 10px;font-weight: bold;">Фильтры:</span>
                    <span class="me-2">Падеж:</span>
                  <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_nomn" value="nomn">
                    <label class="btn btn-labeled" for="filter_cattle_nomn">И.П</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_gent" value="gent">
                    <label class="btn btn-labeled" for="filter_cattle_gent">Р.П</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_datv" value="datv">
                    <label class="btn btn-labeled" for="filter_cattle_datv">Д.П</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_accs" value="accs">
                    <label class="btn btn-labeled" for="filter_cattle_accs">В.П</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_ablt" value="ablt">
                    <label class="btn btn-labeled" for="filter_cattle_ablt">Т.П</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_loct" value="loct">
                    <label class="btn btn-labeled" for="filter_cattle_loct">П.П</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCattle" onchange="radioButtonFilterChanged(event);" id="filter_cattle_not" value="delFilters" checked>
                    <label class="btn btn-labeled" for="filter_cattle_not">Нет</label>
                  </div>
                  <div class="vr"></div>
                  <span class="me-2">Заглавность:</span>
                  <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <input type="radio" class="btn-check filter_radio" name="filterCase" onchange="radioButtonFilterChanged(event);" id="filter_case_upper" value="Upper">
                    <label class="btn btn-labeled " for="filter_case_upper">Заглавные</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCase" onchange="radioButtonFilterChanged(event);" id="filter_case_lower" value="Lower">
                    <label class="btn btn-labeled" for="filter_case_lower">Строчные</label>
                    <input type="radio" class="btn-check filter_radio" name="filterCase" onchange="radioButtonFilterChanged(event);" id="filter_case_not" value="delFilters" checked>
                    <label class="btn btn-labeled" for="filter_case_not">Нет</label>
                  </div>
                  <div class="vr"></div>
                  <span class="me-2">Раскрытие:</span>
                  <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <input type="radio" class="btn-check filter_radio" name="filterRascrit" onchange="radioButtonFilterChanged(event);" id="filter_raskrit_true" value="True">
                    <label class="btn btn-labeled" for="filter_raskrit_true">Раскрыть</label>
                    <input type="radio" class="btn-check filter_radio" name="filterRascrit" onchange="radioButtonFilterChanged(event);" id="filter_raskrit_not" value="delFilters" checked>
                    <label class="btn btn-labeled" for="filter_raskrit_not">Нет</label>
                  </div>
                </div>
                <input list="variable_list" value="" id="span_value" class="form-control" disabled/>
            </div>
            
            <div class="modal fade" id="groupRadioModal" tabindex="-1" aria-labelledby="groupRadioModalLabel" aria-hidden="true">
                <div class="modal-dialog" id="modal_radioGroup">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="groupRadioModalLabel">Альтернативы</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body" id="modal_radioGroup_body">
                        <div class="container" id="leftRadioMenu" >
                            <ul class="list-group" id="modal_radioGroup_list">
                                <div class="RadioGroup" id="radioGroup-1" onclick="radioGroupClick(event);">
                                    <div class="containerTextColorRadioGroup">
                                        <input type="color" value="#ffffff" readonly>
                                        <span>Нет</span>
                                    </div>
                                </div>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success" onclick="addRadioGroup();">Добавить альтернативу</button>
                    </div>
                </div>
                </div>
            </div>
            
            <div class="modal fade" id="errorWindowModal" tabindex="-1" aria-labelledby="errorWindowModalLabel" aria-hidden="true">
                <div class="modal-dialog" id="modal_error">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="errorWindowModalLabel">Ошибка</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body" id="modal_errorWindowModal_body">
                        <h2 id="TypeOfError">
            
                        </h2>
                        <h6 id="TextOfError">
            
                        </h6>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
                </div>
            </div>
            
            <div class="modal fade" id="imageLoadModal" tabindex="-1" aria-labelledby="imageLoadModalLabel" aria-hidden="true">
                <div class="modal-dialog" id="modal_error">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="imageLoadModalLabel">Загрузить изображение</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body" id="modal_imageLoadModal_body">
                        <input id="imageLoadInput" type="file"/>
                        <img id="imgLoadCheckImage" src="">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success" onclick="imageLoadOk();">Добавить изображение</button>
                    </div>
                </div>
                </div>
            </div>
            <div class="modal fade" id="objectConnectModal" tabindex="-1" aria-labelledby="objectConnectModalLabel" aria-hidden="true">
                <div class="modal-dialog" id="modal_error">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="objectConnectModalLabel">Подключение объектов</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                        </div>
                        <div class="modal-body" id="modal_objectConnectModal_body">
                            <label for="objectSelect">Подключаемые объекты:</label>
                            <select id="objectSelect" class="form-select" multiple>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="addObjects();">Добавить объекты</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="objectFindDataModal" tabindex="-1" aria-labelledby="objectFindDataModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl" id="modal_error">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="objectFindDataModalLabel">Поиск объектов</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                        </div>
                        <div class="modal-body" id="modal_objectFindDataModal_body">
                            <div class="header-bar mt-2">
                                <h1 id="objectFindDataModalName">Объект</h1>
                            </div>
                            <div class="d-flex flex-row row mb-5">
                                <span>Идентификатор:</span>
                                <input id="filter-input" class="form-control" type="text" list="idents_list" oninput="onFilterInputInput(event)">
                            </div>
                            <datalist id="idents_list"></datalist>
                            <div class="d-flex flex-row row">
                                <div class="d-flex flex-column col">
                                    <div class="objectFindDataModalContainer row">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="addObjects();">Добавить объекты</button>
                        </div>
                    </div>
                </div>
            </div>
            <datalist id="variable_list">
                <option value="{: Дата сегодня :}" class="option_variable_list"></option>
            </datalist>
            <div class="mainDocument">
                <div id="leftMenu">
                    <a class="btn btn-labeled" data-bs-toggle="modal" data-bs-target="#groupRadioModal" id="btnRadioGroup"><i class="fa-solid fa-list-ol fa-xl"></i></a>
                    <a class="btn btn-labeled" id="btnDependence" onclick="goToDependence();"><i class="fa-solid fa-timeline fa-xl"></i></a>
                    <a class="btn btn-labeled" id="btnAddImage" onclick="ButtonAddImage_Click();"><i class="fa-solid fa-image fa-xl"></i></a>
                </div>
                <div>
                    <div class="document" id="document_main" style="{{ sectPr.to_css }}">
                        {% if type == '1' %}
                            {% for el, key in document %}
                                {% if el.tag == 'p' %}
                                    <div class="paragraph docelement" id="{{ key }}" style="{{ el.pr.to_css }}">
                                        {% for el2 in el.childs %}
                                            {% if el2.text > "" %}
                                                {% if el2.tag == 'r' %}
                                                    <span id="{{ el2.id }}" class="runs docelement" style="{{ el2.pr.to_css }}" data-invis="{{ el2.text }}">{{ el2.text }}</span>
                                                {% elif el2.tag == 'hyperlink' %}
                                                    <span id="{{ el2.id }}" class="hypers docelement" style="{{ el2.pr.to_css }}" data-invis="{{ el2.text }}">{{ el2.text }}</span>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% elif el.tag == 'tbl' %}
                                    <div class="tables docelement" id="{{ key }}" style="{{ el.pr.to_css }}">
                                        <input type="hidden" class="tableGrid" value="{% for gridCol in el.tableGrid %}{% for k,v in gridCol.items %}{{ k }}:{{ v }}|{% endfor %}{% endfor %}">
                                        <table align="center" style="{{ el.pr.to_css }}">
                                        {% for rows in el.childs %}
                                            {% if rows.tag == "tr" %}
                                                <tr style="{{ rows.pr.to_css }}">
                                                    {% for cols in rows.childs %}
                                                        {% if cols.tag == "tc" %}
                                                            <td style="{{ cols.pr.to_css }}">
                                                                {% for paragraphs in cols.childs %}
                                                                    {% if paragraphs.tag == "p" %}
                                                                        <div class="paragraph docelement" style="{{ paragraphs.pr.to_css }}">
                                                                            {% for run in paragraphs.childs %}
                                                                                {% if run.text > "" %}
                                                                                    {% if run.tag == 'r' %}
                                                                                        <span id="{{ run.id }}" class="runs docelement" style="{{ run.pr.to_css }}">{{ run.text }}</span>
                                                                                    {% elif run.tag == 'hyperlink' %}
                                                                                        <span id="{{ run.id }}" class="hypers docelement" style="{{ run.pr.to_css }}">{{ run.text }}</span>
                                                                                    {% else %}
                                                                                        <span id="{{ run.id }}" class="else docelement" style="{{ run.pr.to_css }}">{{ run.text }}</span>
                                                                                    {% endif %}
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </td>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                        </table>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="hidden" id="sectPr" value="{{ sectPr.to_css }}"/>
                </div>
                <div id="line-container"></div>
                <div id="rightMenu1">
                    <div class="form-check form-switch" id="tree_develop_container">
                        <input type="checkbox" class="form-check-input" id="tree_develop" onchange="switchAdminMode(event.target.checked);">
                        <label class="form-check-label" for="tree_develop">Разработчик</label>
                    </div>
                    <div id="rightMenuTopContext" class="invisible">
                        <div class="optionContainer" onclick="OptionContainerIsClicked(event)">
                            <input type="radio" class="btn-check optionInput" name="rightOption" id="optionTreeElement" data-optioned="tree_document" onchange="optionClicked(event);" autocomplete="off" checked/>
                            <label type="button" class="optionLabel" for="optionTreeElement">Дерево элементов</label>
                        </div>
                        <div class="optionContainer" onclick="OptionContainerIsClicked(event)">
                            <input type="radio" class="btn-check optionInput" name="rightOption" id="optionVariables" data-optioned="Variables" onchange="optionClicked(event);" autocomplete="off"/>
                            <label type="button" class="optionLabel" for="optionVariables">Переменные</label>
                        </div>
                        <div class="optionContainer" onclick="OptionContainerIsClicked(event)">
                            <input type="radio" class="btn-check optionInput" name="rightOption" id="optionDependence" data-optioned="Dependences" onchange="optionClicked(event);" autocomplete="off"/>
                            <label type="button" class="optionLabel" for="optionDependence">Зависимости</label>
                        </div>
                    </div>
                    <div id="objectParametersFast">
                        {% for obj in objects %}
                        <div>
                            <span style="font-weight: bold;">{{ obj.object.name }}</span>
                            {% for parameter in obj.params %}
                                {% if parameter.identificator %}
                                    <div class="obj_parameter_fast row" data-idObj="{{ obj.object.id }}" data-idParam="{{ parameter.id }}" data-paramName="{{ obj.object.name }}.{{ parameter.name }}">
                                        <div class="col-2">
                                            <i class="fa-solid fa-star"></i>
                                            <span class="identificator obj_parameter_name">{{ parameter.name }}</span>
                                        </div>
                                        <input type="text" class="form-control identificator col obj_parameter_value" data-id="{{ parameter.id }}" name="{{ parameter.id}}" onclick="getObjectData(event, '{{ obj.object.id }}')" onchange="onChangeVariableMean(event);">
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    <div id="tree_document">
                        <ul class="list-group-flush" id="document_tree"></ul>
                    </div>
                    <div id="fixedVariables">
                        <!-- <div class="form-check form-switch" id="variable_fixed_container">
                            <input type="checkbox" class="form-check-input" id="variable_fixed">
                            <label class="form-check-label" for="variable_fixed">Закрепленные</label>
                        </div> -->
                        <div id="fixedVariablesList"></div>
                    </div>
                    
                    <div id="Variables" class="invisible">
                        <div class="d-flex flex-row align-items-center"><i class="fa-solid fa-bolt fa-xl me-2"></i><h3>Переменные</h3></div>
                        <div class="d-flex flex-column w-100">
                            <h4>Объекты</h4>
                            <a type="button" class="btn btn-success" onclick="ConnectNewObject(event)">Подключить объект</a>
                            <div class="d-flex flex-column w-100">
                                <h5>Подключенные объекты:</h5>
                                <div id="ObjectsList">
                                    {% for obj in objects %}
                                        <div class="object" id="object_{{ obj.object.id }}">
                                            <div class="d-flex flex-row align-items-center object_header">
                                                <span style="font-weight: bold;">{{ obj.object.name }}</span>
                                                <a class="btn btn-labeled" onclick="deleteObjectFromDocument({{ obj.object.id }})"><i class="fa-solid fa-trash" style="color: red;"></i></a>
                                            </div>
                                            <div class="object_body">
                                                <div class="objectParametersContainer">
                                                    <form id="object_form_{{  obj.object.id }}">
                                                        <input type="hidden" name="param_ident_id">
                                                    {% for parameter in obj.params %}
                                                        <div class="obj_parameter row" data-idParam="{{ parameter.id }}" data-paramName="{{ obj.object.name }}.{{ parameter.name }}">
                                                            {% if parameter.identificator %}
                                                                <div class="col-2">
                                                                    <i class="fa-solid fa-star"></i>
                                                                    <span class="identificator obj_parameter_name">{{ parameter.name }}</span>
                                                                </div>
                                                                <input type="text" class="form-control identificator col obj_parameter_value" data-id="{{ parameter.id }}" name="{{ parameter.id}}" onclick="getObjectData(event, '{{ obj.object.id }}')" onchange="onChangeVariableMean(event);">
                                                            {% else %}
                                                                <span class="col-2 obj_parameter_name">{{ parameter.name }}</span>
                                                                {% if parameter.data_type == 'TXT' or parameter.data_type == 'TXTS' %}
                                                                <input type="text" class="form-control col obj_parameter_value" data-id="{{ parameter.id }}" name="{{ parameter.id}}" onchange="onChangeVariableMean(event);" readonly>
                                                                {% elif parameter.data_type == 'DATE' %}
                                                                <input type="text" class="form-control col obj_parameter_value" data-id="{{ parameter.id }}" name="{{ parameter.id}}" onchange="onChangeVariableMean(event);" readonly>
                                                                {% elif parameter.data_type == 'ARRAY' %}
                                                                <div class="col array_data_container obj_parameter_value"></div> 
                                                                {% endif %}
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div>
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <span>Личные</span>
                            <a type="button" class="btn btn-labeled" onclick="CreateNewVariable(undefined, undefined, undefined, 'VariableMyself');">
                                <i class="fa-solid fa-plus"></i>
                            </a>
                        </div>
                        <div class="VariablesList" id="VariableMyself">
                            <div class="variable" data-idvar="system;date_today" ondblclick="SelectVar(event);" style="background-color: white;">
                                <input id="btn_thumbtack_system;date_today" onchange="FixVariable(event);" type="checkbox" class="btn-check variable_thumbtack variable_thumbtack_not_checked" style="">
                                <label class="btn btn-labeled" style="" for="btn_thumbtack_system;date_today"><i class="fa-solid fa-thumbtack"></i></label>
                                <span class="variable_name" contenteditable="true" oninput="onInputVariableName(event);">Дата сегодня</span>
                                <input class="variable_mean" type="date" value="">
                            </div>
                        </div>
                    </div>
                    <div id="Dependences" class="w-100 invisible">
                        <h5>Зависимости</h5>
                        <div id="DependencesList" class="w-100">
                            <div id="EventCallerContainer">
                                <label for="EventCallerID">Отправитель:</label>
                                <select id="EventCallerID" class="form-select" onchange="EventCallerChanged()" class="elementsSelect" disabled>
                                </select>
                                <a type="button" class="btn btn-warning w-25" onclick="onClearEventCallerIdBtnClick()">Очистить</a>
                            </div>
                            <a type="button" class="btn btn-success invisible" id="btnAddReceiver" onclick="PopoverAddEventReceiver();">Добавить зависимость</a>
                            <div id="EventReceiversList">
                            </div>
                        </div>
                    </div>
                </div>
            
            </div>
            <!-- Подложка под модальным окном -->
            <div class="overlay" id="overlay-modal"></div>
            
    </body>
    <script lang="JavaScript">
            
            

            // Класс Стек для Ctrl+Z
            function Stack() {
                this.count = 0
                this.storage = {}

                this.push = function(value) {
                    this.storage[this.count] = value
                    this.count++
                }

                this.pop = function() {
                    if (this.count === 0) return undefined
                    this.count--
                    let result = this.storage[this.count]
                    delete this.storage[this.count]
                    return result
                }

                this.peek = function() {
                    return this.storage[this.count - 1]
                }

                this.size = function() {
                    return this.count
                }
            }

            async function scrollToElement(container, element){
                $(container).scrollTop(
                    $(element).offset().top - $(container).offset().top + $(container).scrollTop()
                );
            }

            async function optionClicked(evt){
                evt.stopPropagation();
                evt.preventDefault();
                document.querySelector('#'+evt.target.getAttribute('data-optioned')).classList.remove('invisible');
                for(let option of document.querySelectorAll('.optionInput')){
                    if(option == evt.target)
                        continue;
                    else{
                        document.querySelector('#'+option.getAttribute('data-optioned')).classList.add('invisible');
                    }
                }
            }

            function SelectVar(evt){
                evt.stopPropagation();
                let variable = evt.target.closest('.variable')
                var elements = document_main.querySelectorAll('.variable_ref[data-idVar="'+ variable.getAttribute('data-idVar') +'"]');
                unsetActiveElements()
                for(let element of elements){
                    addActiveElement(element)
                }
            }

            function SelectFixVar(evt){
                evt.stopPropagation();
                let FixVariable = evt.target.closest('.FixedVariableContainer')
                var elements = document_main.querySelectorAll('.variable_ref[data-idVar="'+ FixVariable.getAttribute('data-idVar') +'"]');
                unsetActiveElements()
                for(let element of elements){
                    addActiveElement(element)
                }
            }

            async function goToDeveloperOption(id_option){
                let tree_develop = document.getElementById('tree_develop')
                let option = document.getElementById(id_option)
                tree_develop.checked = true
                tree_develop.dispatchEvent(new Event('change'))
                option.checked = true
                option.dispatchEvent(new Event('change'))
            }

            function goToDependence(){
                let element = document.querySelectorAll('.selected')[0]
                let caller_select = document.querySelector('#EventCallerID')
                let currentElement = document.getElementById(caller_select.value)
                if(currentElement !== undefined && currentElement !== null)
                    currentElement.classList.remove('selected_event_caller')
                setEventSelect(caller_select, element)
                element.classList.add('selected_event_caller')
                caller_select.dispatchEvent(new Event('change'))
                goToDeveloperOption('optionDependence')
            }

            async function setEventSelect(EventSelect,element){
                EventSelect.innerHTML = ""
                EventSelect.insertAdjacentHTML('beforeend', `
                    <option value="`+ element.id +`">`+ element.getAttribute('data-name') +`</option>
                `)
            }

            async function unsetActiveDependence(){
                // for(let sender of document.querySelectorAll('.selected_event_caller')){
                //     sender.classList.remove('selected_event_caller')
                // }
                for(let receiver of document.querySelectorAll('.hovered_dependence')){
                    receiver.classList.remove('hovered_dependence')
                }
                for(let sender of document.querySelectorAll('.hovered_event_caller')){
                    sender.classList.remove('hovered_event_caller')
                }
            }

            async function setActiveDependence(element){
                await unsetActiveDependence()
                // const pairs = [
                    
                // ];
                for(let event of eventManager.findEventsByReceiver(element.id)){
                    let sender = event.sender
                    let sender_element = document.getElementById(sender)
                    if(sender_element === undefined || sender_element === null)
                        continue
                    sender_element.classList.add('hovered_event_caller')
                    // pairs.push([element, sender_element])
                }
                for(let event of eventManager.findEventsBySender(element.id)){
                    let receiver = event.event.receiver
                    let receiver_element = document.getElementById(receiver)
                    if(receiver_element === undefined || receiver_element === null)
                        continue
                    receiver_element.classList.add('hovered_dependence')
                    // pairs.push([element, receiver_element])
                }
                // const textContainer = document.getElementById('document_main');
               
                // const lineContainer = document.getElementById('line-container');

                // drawLines(textContainer, pairs, lineContainer);
            }

            // Функция, которая выделяет элемент
            async function setActiveElement(element, param){
                if(document_main.querySelectorAll('.selected').length === 1 && document_main.querySelector('.selected') === element)
                    return;
                unsetActiveElements()
                console.log(element)
                if(param !== 0)
                    element.classList.add('selected');
                let tree_elem = document.querySelector('.tree_element[data-idElement="'+ element.id +'"]');
                tree_elem.classList.add('selectedTreeElement');
                let radioGroup = document.getElementById(document_main.querySelector('.selected').getAttribute('data-idRadioGroup'));
                if(radioGroup){
                    radioGroup.classList.add('selectedRadioGroup');
                    document.querySelector('#btnRadioInstruments').style.backgroundColor = radioGroup.querySelector('input').value
                }
                setActiveDependence(element)
                    // Если это текстовый элемент то выделяем его и ставим коретку в конец
                if(element.classList.contains('runs')){
                    let tree_elem_container = tree_elem.parentElement.closest('.tree_element');
                    if(element.classList.contains('variable_ref')){
                        let variable_par =  document.querySelector('.variable[data-idVar="'+element.getAttribute('data-idVar') + '"]')
                        let variable_par_container = variable_par.parentElement
                        //let connection_sel = document.querySelector('#connection_select')
                        let fixVariable = document.querySelector('.FixedVariableContainer[data-idVar="'+element.getAttribute('data-idVar') + '"]')
                        variable_par.classList.add('selectedVar')
                        //connection_sel.value = variable_par.getAttribute('data-idCon')
                        //SelectDataBaseChanged();
                        scrollToElement(document.querySelector('#Variables'), variable_par_container);
                        scrollToElement(variable_par_container, variable_par);
                        if(fixVariable){
                            fixVariable.classList.add('selectedVar')
                            scrollToElement(fixVariable.parentElement, fixVariable);
                        }
                    }
                    scrollToElement(document.querySelector('#document_tree'), tree_elem_container);
                    scrollToElement(document.querySelector('#document_main'), element.parentElement);
                    tree_elem_container.classList.add('selectedTreeElement');
                    element.classList.add('selectedRun');
                    element.parentElement.classList.add('selectedParagraph')
                    //ParagraphBottomContextMenu(element.parentElement);
                    redSpan = element;
                    element.contentEditable = true;
                    ApplyMenu(element)
                    await setEndOfContenteditable(element);
                }
                // Если параграф то запускаем эту функцию с последним элементом
                else if(element.classList.contains('paragraph')){
                    var elements = element.querySelectorAll('.docelement')
                    setActiveElement(elements[elements.length-1], 0);
                } 
                else if(element.classList.contains('imageDocElement')){
                    let tree_elem_container = tree_elem.parentElement.closest('.tree_element');
                    scrollToElement(document.querySelector('#document_tree'), tree_elem_container);
                    scrollToElement(document.querySelector('#document_main'), element.parentElement);
                    tree_elem_container.classList.add('selectedTreeElement');
                    element.classList.add('selectedImg')
                    element.parentElement.classList.add('selectedParagraph')
                    //ParagraphBottomContextMenu(element.parentElement);
                    redSpan = element;
                    ApplyMenu(element)
                }
            }

            // Функция, которая выделяет элемент
            async function addActiveElement(element){
                if(element.classList.contains('selected')){
                    element.classList.remove('selected')
                    if(element.classList.contains('runs')){
                        element.classList.remove('selectedRun')
                        element.parentElement.classList.remove('selectedParagraph')
                    }
                    else if(element.classList.contains('paragraph')){
                        element.classList.remove('selectedParagraph')
                        for(let activeRun of element.querySelectorAll('.selectedRun')){
                            activeRun.classList.remove('selectedRun')
                        }
                    }
                    return
                }
                element.classList.add('selected');
                let tree_elem = document.querySelector('.tree_element[data-idElement="'+ element.id +'"]');
                tree_elem.classList.add('selectedTreeElement');
                let radioGroup = document.getElementById( document_main.querySelector('.selected').getAttribute('data-idRadioGroup'));
                if(radioGroup){
                    let radioGroup = document.getElementById(document_main.querySelectorAll('.selected')[0].getAttribute('data-idRadioGroup'));
                    radioGroup.classList.add('selectedRadioGroup');
                }
                // Если это текстовый элемент то выделяем его и ставим коретку в конец
                if(element.classList.contains('runs')){
                    element.classList.add('selectedRun');
                    element.parentElement.classList.add('selectedParagraph')
                    //ParagraphBottomContextMenu(element.parentElement);
                    // redSpan = element;
                    // element.contentEditable = true;
                    ApplyMenu(element)
                    await setEndOfContenteditable(element);
                }
                // Если параграф то запускаем эту функцию с последним элементом
                else if(element.classList.contains('paragraph')){
                    element.classList.add('selectedParagraph')
                    var elements = element.querySelectorAll('.docelement')
                    for(let elem of elements){
                        elem.classList.add('selectedRun')
                    }
                } 
            }

            async function switchAdminMode(enable){
                let tree = document.querySelector('#tree_document')
                let Context = document.querySelector('#rightMenuTopContext')
                let fixVariables = document.querySelector('#fixedVariables')
                let variables = document.querySelector('#Variables')
                let object_param_fast = document.querySelector('#objectParametersFast')
                if(enable){
                    Context.classList.remove('invisible')
                    document.querySelector('#optionTreeElement').checked = true;
                    fixVariables.classList.add('invisible')
                    variables.classList.add('invisible')
                    tree.classList.remove('invisible')
                    tree.querySelector('#document_tree').classList.remove('smaller')
                    object_param_fast.classList.add('invisible')
                }
                else{
                    Context.classList.add('invisible')
                    document.querySelector('#rightMenu1').insertBefore(fixVariables, tree)
                    fixVariables.classList.remove('invisible')
                    variables.classList.add('invisible')
                    tree.classList.remove('invisible')
                    tree.querySelector('#document_tree').classList.add('smaller')
                    object_param_fast.classList.remove('invisible')
                }
                for(let tree_elem of document.querySelectorAll('.tree_element')){
                    if(enable){
                        tree_elem.removeAttribute('hidden');
                        tree_elem.querySelector('.setUserCheckboxLabel').removeAttribute('hidden')
                    }
                    else{
                        if(tree_elem.classList.contains('userCanSee')){
                            tree_elem.removeAttribute('hidden');
                            tree_elem.querySelector('.setUserCheckboxLabel').setAttribute('hidden', 1)
                        }
                        else{
                            tree_elem.setAttribute('hidden', 1);
                        }
                    }
                }
            }


            async function unsetElement(element, elementType){
                try {
                    let tree_element = document.querySelector('.tree_element[data-idElement="'+ element.id +'"]');
                    element.classList.remove('selected');
                    element.classList.remove(elementType);
                    element.contentEditable = false;
                    if(tree_element)
                        document.querySelector('.tree_element[data-idElement="'+ element.id +'"]').classList.remove('selectedTreeElement');
                    return true    
                } catch (error) {
                    return false
                }
            }

            async function unsetAllElementsOfContainer(container, elementType) {
                for(let element of container){
                    unsetElement(element, elementType)
                }
            }

            // Снятие выделения всех элементов
            async function unsetActiveElements(){
                unsetAllElementsOfContainer(document.querySelectorAll('.selectedRun'), 'selectedRun')
                unsetAllElementsOfContainer(document.querySelectorAll('.selectedParagraph'), 'selectedParagraph')
                unsetAllElementsOfContainer(document.querySelectorAll('.selectedVar'), 'selectedVar')
                unsetAllElementsOfContainer(document.querySelectorAll('.selectedRadioGroup'), 'selectedRadioGroup')
                unsetAllElementsOfContainer(document.querySelectorAll('.selectedTreeElement'), 'selectedTreeElement')
                document.querySelector('#btnRadioInstruments').style.backgroundColor = "#ffffff"
                // document.querySelector('#context_add_menu').hidden = true;
                //document_main.appendChild(document.querySelector('#context_add_menu'));
            }

            // Функция включает и отключает отображение всех элементов
            async function SetNotHidden(){
                // Если кнопка нажата, то включаем
                if(document.querySelector('#btn_check_nothidden').checked){
                    for(element of document.querySelectorAll('.docelement')){
                        try {

                            element.classList.add('docelementNotHidden'); 
                        } catch (error) {
                            continue;
                        }
                    }
                }
                // Иначе отключаем
                else{
                    for(element of document.querySelectorAll('.docelementNotHidden')){
                        try {
                            element.classList.remove('docelementNotHidden');
                        } catch (error) {
                            continue;
                        }
                    }
                }
            }

            // Добавления контекстного меню внизу выделенного параграфа
            // async function ParagraphBottomContextMenu(paragraph){
            //     var context = document.querySelector('#context_add_menu');
            //     context.hidden = false;
            //     paragraph.appendChild(context);
            // }

            // Текстовые элементы из JSON
            function TextFromJSON(child){
                // return 
                // `
                //     <span 
                //     class="runs docelement `+ child['userCanSee']?'userCanSeeInTree':'' + document.querySelector('#btn_check_nothidden').checked?'docelementNotHidden':''+`"
                //     id=`+child['id']+`

                //     ></span>
                // `
                var span = document.createElement('span');
                span.classList.add('runs');
                span.classList.add('docelement');
                if(child['userCanSee'])
                    span.classList.add('userCanSeeInTree')
                if(document.querySelector('#btn_check_nothidden').checked){
                    span.classList.add('docelementNotHidden');
                }
                span.id = child['id'];
                for(let [key, value] of Object.entries(child['style'])){
                    span.style[key] = value;
                }
                span.textContent = child['text'];
                span.setAttribute('data-invis', child['data-invis']);
                span.setAttribute('data-name', child['data-name']);
                if(!child['data-idRadioGroup'])
                    child['data-idRadioGroup'] = "radioGroup-1"
                span.setAttribute('data-idRadioGroup', child['data-idRadioGroup']);
                span.hidden = child['hidden'];
                SetDefaultRun(span);
                return span;
            }

            function ImageFromJSON(child){
                var span = document.createElement('div');
                span.classList.add('imageDocElement');
                span.classList.add('docelement');
                span.style.cssText = `width:`+ Number(child['width']) / 0.2636 +`px;
                height:`+ Number(child['height']) / 0.2636 +`px;`
                if(child['userCanSee'])
                    span.classList.add('userCanSeeInTree')
                if(!child['data-idRadioGroup'] || child['data-idRadioGroup'] == "undefined")
                    child['data-idRadioGroup'] = "radioGroup-1"
                span.setAttribute('data-idRadioGroup', child['data-idRadioGroup'])
                if(document.querySelector('#btn_check_nothidden').checked){
                    span.classList.add('docelementNotHidden');
                }
                span.id = child['id'];
                for(let [key, value] of Object.entries(child['style'])){
                    span.style[key] = value;
                }
                span.insertAdjacentHTML('beforeend',
                `
                    <img class="imageForDocElement" src="`+'/media'+child['src'].split('media')[1]+`" >
                `)
                span.setAttribute('data-name', child['data-name']);
                span.hidden = child['hidden'];
                SetDefaultIMG(span);
                return span;
            }

            // Параграфы из JSON
            function ParagraphFromJSON(child){
                var par = document.createElement('div');
                par.classList.add('paragraph');
                par.classList.add('docelement');
                if(child['userCanSee'])
                    par.classList.add('userCanSeeInTree')
                par.setAttribute('data-name', child['data-name']);
                if(!child['data-idRadioGroup'] || child['data-idRadioGroup'] == "undefined")
                    child['data-idRadioGroup'] = "radioGroup-1"
                par.setAttribute('data-idRadioGroup', child['data-idRadioGroup']);
                par.hidden = child['hidden'];
                if(document.querySelector('#btn_check_nothidden').checked){
                    par.classList.add('docelementNotHidden');
                }
                par.id = child['id'];
                for(let child1 of child['childs']){
                    childParsed = JSON.parse(child1)
                    switch(childParsed['class']){
                        case 'runs':
                            par.appendChild(TextFromJSON(childParsed));
                            break;
                        case 'img':
                            par.appendChild(ImageFromJSON(childParsed));
                            break;
                    }
                }
                for(let [key, value] of Object.entries(child['style'])){
                    if(key!='textIndent')
                        par.style[key] = value;
                    else{
                        par.style[key] = value;
                    }
                }
                SetDefaultPar(par);
                return par;
            }
            
            // Формирует документ из JSON
            async function DocFromJSON(data) {
                try {
                    var jsonp = JSON.parse(data);
                    for(let element of jsonp['elements']){
                        var child = JSON.parse(element);
                        if(child['class'] == 'paragraph'){
                            document_main.appendChild(ParagraphFromJSON(child));
                        }
                    }
                    if(document_main.querySelectorAll('.paragraph').length == 0){
                        console.log('Параграфов нет, добавляю пустой')
                        AddParagraphTo(document_main)
                    }
                    if(jsonp['events'])
                        eventManager.eventHashTable = jsonp['events']
                } catch (error) {
                    if(document_main.querySelectorAll('.paragraph').length == 0){
                        console.log('Параграфов нет, добавляю пустой')
                        AddParagraphTo(document_main)
                    }
                    console.log(error)
                    return;
                }
            }

            // Восстанавливает закреплённые переменные из JSON
            async function FixedVariablesFromJSON(data) {
                try {
                    var jsonp = JSON.parse(data);
                    for(let element of jsonp['fixedVariable']){
                        const variable = document.querySelector('.variable[data-idVar="'+ element['id'] +'"]')
                        if(!variable){
                            continue;
                        }
                        CreateFixedVariable(variable)
                        variable.querySelector('input[id^="btn_thumbtack_"]').checked = true;
                        variable.querySelector('input[id^="btn_thumbtack_"]').classList.add('variable_thumbtack_checked')
                        variable.querySelector('input[id^="btn_thumbtack_"]').classList.remove('variable_thumbtack_not_checked')
                    }
                } catch (error) {
                    return;
                }
            }

            async function RadioGroupColorChanged(evt){
                var radioGroup = evt.target.closest(".RadioGroup")
                document.querySelector('.dropdownRadioGroup[data-idRadioGroup="'+ radioGroup.id +'"]').style.backgroundColor = evt.target.value
                document.querySelector('#btnRadioInstruments[data-idRadioGroup="'+ radioGroup.id +'"]').style.backgroundColor = evt.target.value
                var tree_elements_indicators = document.querySelectorAll('.hideCheckbox[name="'+ radioGroup.id +'"] ~ .radioGroupIndicator')
                for(let tei of tree_elements_indicators){
                    tei.style.backgroundColor = evt.target.value
                }
            }

            async function radioGroupNameChanged(evt){
                var radioGroup = evt.target.closest(".RadioGroup")
                const id = radioGroup.id
                document.querySelector('.dropdownRadioGroup[data-idRadioGroup="'+ id +'"] > span').textContent = evt.target.textContent
            }

            // Восстанавливает радиогруппы из JSON
            async function RadioGroupsFromJSON(data){
                var jsonp = JSON.parse(data);
                if(!jsonp['radioGroups'] || jsonp['radioGroups'].length == 0)
                    return;
                for(let key of jsonp['radioGroups']['childs']){
                    // var radioGroup = createRadioGroup(key['name'], key['color'], key['id']);
                    // modal_radioGroup_list.appendChild(radioGroup);
                    modal_radioGroup_list.insertAdjacentHTML('beforeend', `
                    <div class="RadioGroup" id="` + key['id'] + `" onclick="radioGroupClick(event);">
                        <div class="containerTextColorRadioGroup">
                            <input type="color" onchange="RadioGroupColorChanged(event);" value="`+ key['color'] +`">
                            <span contenteditable="true" oninput="radioGroupNameChanged(event);">`+ key['name'] +`</span>
                        </div>
                    </div>
                    `)
                    document.querySelector(".dropdown-menu").insertAdjacentHTML('beforeend', `
                        <li class="dropdownRadioGroup" onclick="radioGroupClickInstrument(event)" data-idRadioGroup="`+ key['id'] +`" type="button"><a class="dropdown-item" style="background-color:`+ key['color'] +`"></a><span>`+key['name']+`</span></li>
                    `)
                    // for(let child of key['childs']){
                    //     var treeElementInRadio = document.querySelector('.TreeElementInModalList[data-idElement="'+child['data-idElement']+'"]');
                    //     ElementInRadioGroup(child['data-idElement'], radioGroup.firstElementChild.lastElementChild.id);
                    //     radioGroup.firstElementChild.lastElementChild.firstElementChild.appendChild(treeElementInRadio);
                    // }
                    //InputColor(radioGroup.firstElementChild.firstElementChild.lastElementChild);
                }
            }
            
            // Восстанавливает сохранённые элементы из JSON
            async function ListSavedFromJSON(data) {
                var jsonp = JSON.parse(data);
                for(let [key, value] of Object.entries(jsonp)){
                    var child = JSON.parse(value);
                    child = JSON.parse(child);
                    if(child['class'] == 'paragraph'){
                        SaveElementToList(ParagraphFromJSON(child), key.split(':')[0], key.split(':')[1]);
                    }
                    else if(child['class'] == 'runs'){
                        SaveElementToList(TextFromJSON(child), key.split(':')[0], key.split(':')[1]);
                    }
                }

            }

            // Сохраняет в стек текущую версию
            async function SaveLastVersion(){
                var arr = []
                for(let child of document.getElementsByClassName("document")[0].children){
                    arr.push(child.cloneNode(true));
                }
                lastVersions.push(arr);
                SaveNotComplete();
            }

            function getDataFromObjectArray(element){
                let text = '';
                let arr_datas = element.querySelectorAll('.array_data span')
                if(arr_datas.length == 0)
                    return '';
                for(let i=0; i < arr_datas.length-1; i++){
                    text += arr_datas[i].textContent.trim() + ', ';
                }
                text += arr_datas[arr_datas.length-1].textContent.trim()
                return text
            }

            // Создаёт соединение между переменной и текстовым элементом
            function CreateConnectObject(span, regmatch){
                var name = span.getAttribute('data-invis').trim();
                name = name.slice(3, name.length-3);
                for(let objects_param of document.getElementsByClassName('obj_parameter')){
                    var nam = objects_param.getAttribute('data-paramName');
                    var val = objects_param.querySelector('.obj_parameter_value')
                    if(nam == name){
                        
                        
                        span.classList.add('reference_to_data');
                        span.classList.add('object_param_ref');
                        span.setAttribute('data-idObjParam', objects_param.getAttribute('data-idParam'))
                        span.addEventListener("beforeinput", (e)=>{e.preventDefault();});
                        if(val.value != '')
                            span.textContent = getDataFromReference(span)
                        else
                            span.textContent = '{: '+ nam + ' :}'
                        return true;
                    }
                }
                return false;
            }

            function CreateConnect(span, regmatch){
                var name = span.getAttribute('data-invis').trim();
                name = name.slice(3, name.length-3);
                for(let variable of document.querySelectorAll('.VariablesList .variable')){
                    var nam = variable.getElementsByClassName('variable_name')[0];
                    var val = variable.getElementsByClassName('variable_mean')[0];
                    if(nam.textContent == name){
                        span.classList.add('reference_to_data');
                        span.classList.add('variable_ref');
                        span.setAttribute('data-idVar', variable.getAttribute('data-idVar'))
                        span.addEventListener("beforeinput", (e)=>{e.preventDefault();});
                        if(val.value != '')
                            span.textContent = getDataFromReference(span)
                        else
                            span.textContent = '{: '+ nam.textContent + ' :}'
                        //FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                        return true;
                    }
                }
                return false;
            }

            // Проверка на то, хранит ли в себе текстовый элемент значение переменной
            async function CheckOnVariableInSpan(span){
                let regexp = new RegExp("{: .* :}")
                var regsovpad = regexp.exec(span.getAttribute('data-invis'));
                if(regexp.test(span.getAttribute('data-invis').trim())){
                    if(!CreateConnect(span, regsovpad) && !CreateConnectObject(span, regsovpad)){
                        span.classList.remove('reference_to_data');
                        span.classList.remove('variable_ref');
                        span.classList.remove('object_param_ref');
                        span.contentEditable = true;
                        span.addEventListener("beforeinput", (e)=>{});
                    }
                }
                else{
                    span.classList.remove('reference_to_data');
                    span.classList.remove('variable_ref');
                    span.classList.remove('object_param_ref');
                    span.contentEditable = true;
                    span.addEventListener("beforeinput", (e)=>{});
                    
                }
            }


            // Обработчик нажатия на кнопки выравнивания
            async function OnAlignButtonClick(button){
                for(let activeElement of document.querySelectorAll('.selectedParagraph')){
                    switch(button.id){
                        case 'leftAlign':
                            activeElement.style.textAlign = "left";
                            break;
                        case 'centerAlign':
                            activeElement.style.textAlign = "center";
                            break;
                        case 'rightAlign':
                            activeElement.style.textAlign = "right";
                            break;
                        case 'bothAlign':
                            activeElement.style.textAlign = "justify";
                            break;
                    }
                }
            }

            // Нажать на кнопки выравнивания в зависимости от стилевых настроек параграфа
            async function ApplyAlign(element){
                try{
                    switch(element.style.textAlign){
                        case 'left':
                            leftAlign.checked = true;
                            break;
                        case 'center':
                            centerAlign.checked = true;
                            break;
                        case 'right':
                            rightAlign.checked = true;
                            break;
                        case 'justify':
                            bothAlign.checked = true;
                            break;
                        default:
                            leftAlign.checked = true;
                            element.style.textAlign = "left";
                    }
                }
                catch(err){
                    return;
                }
            }

            // Задать жирность шрифта текстовому элементу
            async function SetBold(){
                for(let activeElement of document.querySelectorAll('.selected')){
                    if(activeElement.classList.contains('runs')){
                        if(btn_check_bold.checked)
                            activeElement.style.fontWeight = "bold";
                        else
                            activeElement.style.fontWeight = "normal";
                    }
                    else if(activeElement.classList.contains('paragraph')){
                        for(let activeRun of activeElement.querySelectorAll('.selectedRun')){
                            if(btn_check_bold.checked)
                                activeRun.style.fontWeight = "bold";
                            else
                                activeRun.style.fontWeight = "normal";
                        }
                    }
                }
            }

        // Задать курсив шрифта текстовому элементу
            async function SetItalic(){
                for(let activeElement of document.querySelectorAll('.selected')){
                    if(activeElement.classList.contains('runs')){
                        if(btn_check_italic.checked)
                            activeElement.style.fontStyle = "italic";
                        else
                            activeElement.style.fontStyle = "normal";
                    }
                    else if(activeElement.classList.contains('paragraph')){
                        for(let activeRun of activeElement.querySelectorAll('.selectedRun')){
                            if(btn_check_italic.checked)
                                activeRun.style.fontStyle = "italic";
                            else
                                activeRun.style.fontStyle = "normal";
                        }
                    }
                }
            }

            // Задать подчёркивание шрифта текстовому элементу
            async function SetUnderline(){
                for(let activeElement of document.querySelectorAll('.selected')){
                    if(activeElement.classList.contains('runs')){
                        if(btn_check_underline.checked)
                            activeElement.style.textDecoration = "underline";
                        else
                            activeElement.style.textDecoration = "none";
                    }
                    else if(activeElement.classList.contains('paragraph')){
                        for(let activeRun of activeElement.querySelectorAll('.selectedRun')){
                            if(btn_check_underline.checked)
                                activeRun.style.textDecoration = "underline";
                            else
                                activeRun.style.textDecoration = "none";
                        }
                    }
                }
            }

            // Закрепить переменную
            async function FixVariable(evt){
                const variable = evt.target.closest('.variable')
                if(evt.target.checked){
                    evt.target.classList.add('variable_thumbtack_checked')
                    evt.target.classList.remove('variable_thumbtack_not_checked')
                    CreateFixedVariable(variable);
                }
                else{
                    evt.target.classList.remove('variable_thumbtack_checked')
                    evt.target.classList.add('variable_thumbtack_not_checked')
                    DeleteFixedVariable(variable);
                }
            }

            // Создать элемент закреплённой переменной
            async function CreateFixedVariable(variable){
                let fixVarList = document.querySelector('#fixedVariablesList');
                fixVarList.insertAdjacentHTML('beforeend',
                `
                <div class="FixedVariableContainer" data-idvar="`+variable.getAttribute('data-idVar')+`" ondblclick="SelectFixVar(event);">
                    <span class="FixedVariableName">`+variable.querySelector('.variable_name').textContent+`</span>
                    <input class="FixedVariableValue" value="`+variable.querySelector('.variable_mean').value+`">
                </div>
                `
                )

                var value = fixVarList.lastElementChild.querySelector('.FixedVariableValue');
                value.oninput = (evt)=>{
                    variable.querySelector('.variable_mean').value = value.value
                }
                value.onchange = (evt)=>{
                    for(let span of document.getElementsByClassName('reference_to_data')){
                        CheckOnVariableInSpan(span);
                    }
                }
            }

            // Удалить элемент закреплённой переменной
            async function DeleteFixedVariable(variable){
                const fixVar = document.querySelector('.FixedVariableContainer[data-idVar="'+ variable.getAttribute('data-idVar') +'"]');
                document.querySelector('#fixedVariablesList').removeChild(fixVar);
            }

            // Проверка на уникальность имени сохранённого элемента
            function CheckNameElementFromList(name){
                for(var elem of list_saved_sp.children){
                    if(elem.firstChild.firstChild.textContent == name)
                        return false;
                }
                return true;
            }

            // Проверка на уникальность ID сохранённого элемента
            function CheckIdElementFromList(id){
                for(var elem of list_saved_sp.children){
                    if(elem.id == id)
                        return false;
                }
                return true;
            }

            // Сохранение элемента в список сохранённых элементов
            function SaveElementToList(element, name, id){
                var list = document.getElementById("list_saved_sp");
                var divSmall = document.createElement("span");
                var divElem = element.cloneNode(true);
                var divBig = document.createElement("div");
                var li = document.createElement("li");

                divSmall.className = "fw-bold";
                if(name == undefined){
                    var i = 1;
                    while(!CheckNameElementFromList("Элемент" + i)){
                        i++;
                    }
                    divSmall.textContent = "Элемент" + i;
                }
                else
                    divSmall.textContent = name;
                divSmall.classList.add("list_saved_element_label");
                divSmall.contentEditable = true;

                divElem.hidden = true;

                divBig.classList.add('savedElement_container');
                divBig.classList.add("ms-2") ;
                divBig.classList.add("me-auto");
                divBig.appendChild(divSmall);
                divBig.appendChild(divElem);

                var btns_container = document.createElement('div');
                btns_container.classList.add('savedElement_btns');
                var btn_close = document.createElement('button');
                btn_close.type = 'button';
                btn_close.classList.add('btn-close');
                btn_close.setAttribute('aria-label', 'Close');
                btn_close.style.maxHeight = '7px'; 

                btn_close.onclick = function(evt){
                    var list_element = btn_close.parentNode.parentNode.parentNode;
                    $.ajax({
                        type: "POST",
                        url: "/document/savedelement/delete",
                        data: JSON.stringify({'id': list_element.getAttribute('data-idDB')}),
                        contentType: "application/json; charset=utf-8",
                        success: list_element.parentNode.removeChild(list_element)
                    });
                }

                btns_container.appendChild(btn_close);
                divBig.appendChild(btns_container);

                li.classList.add("list-group-item");
                li.classList.add("d-flex");
                li.classList.add("justify-content-between");
                li.classList.add("align-items-start");
                li.classList.add("list_saved_element");
                if(id == undefined){
                    var i = 1;
                    while(!CheckIdElementFromList("listElement_" + i)){
                        i++;
                    }
                    li.setAttribute('data-idDB', -1)
                    li.id = "listElement_" + i;
                }
                else{
                    li.setAttribute('data-idDB', id)
                    li.id = "listElement_" + id;
                }
                li.draggable = true;
                li.addEventListener('dragstart', (evt) => {
                    evt.stopPropagation();
                    var elem = evt.target.firstElementChild.children[1];
                    elem.classList.add('dragged');
                    evt.dataTransfer.setData("id", evt.target.id);
                    evt.dataTransfer.setData("type", 'saved');
                });
                li.appendChild(divBig);
                list.appendChild(li);
                
            }

            // Задать дефолтное значение всему в документе
            function SetDefault(){
                var spans = document.querySelectorAll(".runs");
                for(let span of spans){
                    SetDefaultRun(span);
                    CheckOnVariableInSpan(span);
                }

                var paragraphs = document.querySelectorAll(".paragraph");
                for(let paragraph of paragraphs)
                    SetDefaultPar(paragraph);

                var variables = document.querySelectorAll(".variable");
                for(let variable of variables)
                    SetDefaultVariable(variable);
                SetDragAndDrop();
            }

            // Задать свойства работы Drag'n'Drop в документе
            function SetDragAndDrop(){
                var doc = document.querySelector(".mainDocument");
                doc.addEventListener('dragstart', function(evt) {
                    if(!evt.target.classList.contains("docelement"))
                        return;
                    setActiveElement(evt.target);
                    evt.target.classList.add('dragged');
                    evt.dataTransfer.setData('id', evt.target.id);
                    evt.stopPropagation();
                    SaveLastVersion();
                });
                doc.addEventListener('dragend', function(evt) {
                    try {
                        
                        document.querySelector('.dragged').classList.remove('dragged')
                        
                    } catch (error) {
                        // list_saved.style.border = "";
                        return
                    }
                });

                doc.addEventListener('drop', async function(evt){
                    evt.stopPropagation();
                    var draggedElement = document.querySelector('.dragged');
                    evt.preventDefault();
                    var id = evt.dataTransfer.getData('id');
                    var type = evt.dataTransfer.getData('type');
                    var spans = document_main.getElementsByClassName('runs');
                    for(let span of spans){
                        CheckOnVariableInSpan(span);
                    }
                    // if(type == 'saved'){
                    //     var element = draggedElement.cloneNode(true);
                    //     var paragraph = evt.target.closest('.paragraph');
                    //     console.log(element);
                    //     if(element.classList.contains('runs')){
                    //         if(paragraph){
                    //             paragraph.appendChild(element);
                    //             element.removeAttribute('hidden');
                    //             SetDefaultRun(element);
                    //             var span = document.getElementById(element.id);
                    //             if(span && span !== element)
                    //                 element.id = "r_"+GetId();
                    //         } 
                    //     }
                    //     else if(element.classList.contains('paragraph')){
                    //         if(paragraph){
                    //             paragraph.parentElement.insertBefore(element, paragraph);
                    //             element.removeAttribute('hidden');
                    //             SetDefaultPar(element);
                    //             element.id = "p_"+GetId();
                    //         }
                    //     }
                        
                    //}
                    // list_saved.style.border = "";
                    
                });

                // doc.addEventListener('dragleave', function(evt){
                //     list_saved.style.border = "";
                // });

                doc.addEventListener('dragover', async function(evt) {
                    try {
                        evt.preventDefault(); // Прерываем дефолтное реагирование браузера
                        const currentElement = evt.target; // Элемент над которым находится перетаскиваемый объект
                        const draggedElement = document.querySelector('.dragged') // Перетаскиваемый элемент
                        
                        // Прокручивание на краях документа
                        if(evt.clientY <= 180 && evt.clientY > 170) 
                            window.scrollBy(0, -100);
                        else if(evt.clientY >= 700)
                            window.scrollBy(0, 100);
                        // Если переносим в список сохранённых элементов
                        // if(currentElement.closest("#list_saved")){
                        //     list_saved.style.border = "2px dashed green";
                        // }
                        // Если перетаскиваемый элемент - текстовый элемент
                        if(draggedElement.classList.contains('runs') || draggedElement.classList.contains('imageDocElement')){
                            const parentDragged = draggedElement.closest('.paragraph')
                            // Есть ли возможность перенести?
                            const isMoveable = draggedElement !== currentElement &&
                            currentElement.classList.contains('runs');
                            // Если нет, то проверяем может это параграф где пользователь навёлся на пустую область
                            if (!isMoveable) {
                                // Если так и сть, то вставляем в параграф
                                if(currentElement.classList.contains('paragraph')){
                                    currentElement.appendChild(draggedElement);
                                }
                                if(!parentDragged.children.length){
                                    parentDragged.parentElement.removeChild(paragraph)
                                }
                                return;
                            }
                            // Функция для получения элемента, перед которым вставим перетаскиваемый элемент
                            const getNextElement = (cursorPosition, currentElement) => {
                                const currentElementCoord = currentElement.getBoundingClientRect();
                                const currentElementCenter = currentElementCoord.x + currentElementCoord.width / 2;
                                const nextElement = (cursorPosition < currentElementCenter) ?
                                    currentElement :
                                    currentElement.nextElementSibling;
                                return nextElement;
                            };
                            // Получаем такой элемент
                            const nextElement = getNextElement(evt.clientX, currentElement);
                            // Если элемент не пустой и перетаскиваемый элемент уже не является его левым соседом или им самим
                            if (nextElement &&
                                draggedElement === nextElement.previousElementSibling ||
                                draggedElement === nextElement){return;}
                            // То вставляем перед этим элементом перетаскиваемый элемент
                            nextElement.parentNode.insertBefore(draggedElement, nextElement);
                            if(!parentDragged.children.length){
                                parentDragged.parentElement.removeChild(paragraph)
                            }
                        }
                        else if (draggedElement.classList.contains('paragraph')){ // С параграфом то же самое
                            const isMoveable = draggedElement !== currentElement &&
                            currentElement.classList.contains('paragraph');
                            if (!isMoveable) {
                                return;
                            }

                            const getNextElement = (cursorPosition, currentElement) => {
                                const currentElementCoord = currentElement.getBoundingClientRect();
                                const currentElementCenter = currentElementCoord.y + currentElementCoord.height / 2;
                                const nextElement = (cursorPosition < currentElementCenter) ?
                                    currentElement :
                                    currentElement.nextElementSibling;
                                return nextElement;
                            };

                            const nextElement = getNextElement(evt.clientY, currentElement);
                            if (nextElement &&
                                draggedElement === nextElement.previousElementSibling ||
                                draggedElement=== nextElement){return;}
                                document_main.insertBefore(draggedElement, nextElement);
                        } 
                    } catch (error) {
                        return;
                    }
                    
                });
            }


            async function SetDefaultIMG(img){
                img.onclick = function(event){
                    if(event.ctrlKey || event.metaKey){
                        addActiveElement(img);
                    }
                    else{

                        setActiveElement(img)
                    }

                }
                img.draggable = true;
                img.contentEditable = false;
            }

            function changeQuotes(text) {
                return text.replace(/(\w)"(\w)/g, '$1\x27$2')
                    .replace(/(^|\s|\()"/g, "$1«")
                    .replace(/"(\;|\!|\?|\:|\.|\,|$|\)|\s)/g, "»$1");
            }

            // Задать начальное значение текстовому элементу
            async function SetDefaultRun(run){
                if(run.style.fontSize == ""){
                    run.style.fontSize = String(startFontSize + 3) + 'px';
                }
                if(run.style.fontFamily == ""){
                    run.style.fontFamily = startFont;
                }
                
                run.onclick = function(event){
                    if(document.querySelector('#document_main').classList.contains('get_event_receiver')){
                        let sender = document.getElementById('EventCallerID').value
                        let sender_element = document.getElementById(sender)
                        AddEventReceiver(run, sender_element, 'hidden', 'hide', true)
                    }
                    if(event.ctrlKey || event.metaKey){
                        addActiveElement(run);
                    }
                    else{
                        setActiveElement(run)
                    }
                }
                run.oncontextmenu = function(event){
                    setActiveElement(run)
                }
                run.oninput = (evt)=>{
                    redSpan = run;
                    run.setAttribute('data-invis', run.textContent);
                    run.setAttribute('data-name', String(run.textContent).substring(0, run.textContent.length > 50 ? 50 : run.textContent.length));
                    span_value.value = run.getAttribute('data-invis');
                    FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                }
                // run.onkeydown = (evt) => {
                //     if (evt.key === 'Tab' || evt.key === 'Enter') {
                //         run.textContent = changeQuotes(run.textContent);
                //     }
                // }
                run.onpaste = async function(event){
                    event.stopPropagation();
                    event.preventDefault();
                    var pasted = event.clipboardData.getData('text/plain');
                    var pasted_splited = [];
                    if(pasted.indexOf('\r\n') != -1){
                        var pasted_splited = pasted.split('\r\n');
                    }
                    else if(pasted.indexOf('\r\n') == -1 && pasted.indexOf('\n') != -1){
                        var pasted_splited = pasted.split('\n');
                    }
                    run.textContent = pasted_splited[0];
                    var lastPar = run.parentElement;
                    pasted_splited.shift();
                    for(let past of pasted_splited){
                        var par = await AddParagraphAfter(lastPar);
                        par.firstElementChild.textContent = past;
                        lastPar = par;
                    }
                    
                }
                run.classList.add("runs");
                run.classList.add("docelement");
                if(!run.getAttribute('data-name'))
                    run.setAttribute("data-name", "")
                if(document.querySelector('#btn_check_nothidden').checked){
                    run.classList.add('docelementNotHidden');
                }
                run.draggable = true;
                run.contentEditable = false;
                if(!run.getAttribute('data-invis'))
                    run.setAttribute('data-invis', run.textContent);
            }

            // Поставить каретку в конец SPAN с аттрибутом contenteditable
            async function setEndOfContenteditable(contentEditableElement)
            {
                contentEditableElement.focus();
                document.execCommand('selectAll', false, null);
                document.getSelection().collapseToEnd();
            }

            function saveCursorPosition(contentEditableElement) {
                contentEditableElement.focus();
                const selection = document.getSelection();
                const anchorOffset = selection.anchorOffset;
                return anchorOffset;
            }
            
            function restoreCursorPosition(contentEditableElement, anchorOffset) {
                contentEditableElement.focus();
                const selection = document.getSelection();
                selection.collapse(contentEditableElement, anchorOffset);
            }

            // Задать начальное значение параграфу
            async function SetDefaultPar(paragraph){
                paragraph.onclick = (evt) => {
                    if(!evt.target.classList.contains('paragraph'))
                        return;
                    if(document.querySelector('#document_main').classList.contains('get_event_receiver')){
                        let sender = document.getElementById('EventCallerID').value
                        let sender_element = document.getElementById(sender)
                        AddEventReceiver(paragraph, sender_element, 'hidden', 'hide', true)
                    }
                    if(event.ctrlKey || event.metaKey){
                        addActiveElement(paragraph);
                    }
                    else{
                        setActiveElement(paragraph)
                    }
                }
                // paragraph.oncontextmenu = function(event){
                //     setActiveElement(paragraph)
                // }
                paragraph.ondblclick = (evt)=>{
                    if(paragraph.children.length == 0){
                        AddRunTo(paragraph);
                    }
                    else{
                        elements = paragraph.querySelectorAll('.docelement')
                        lastRun = paragraph.children[elements.length-1];
                        setActiveElement(lastRun)
                    }
                }
                for(let runs of paragraph.children){
                    if(runs.classList.contains("runs")){
                        SetDefaultRun(runs);
                    }     
                }
                paragraph.classList.add("paragraph");
                paragraph.classList.add("docelement");
                paragraph.style.marginTop = '0em'
                paragraph.style.marginBottom = '0em'
                if(!paragraph.getAttribute('data-name'))
                    paragraph.setAttribute("data-name", "")
                if(document.querySelector('#btn_check_nothidden').checked){
                    paragraph.classList.add('docelementNotHidden');
                }
                paragraph.draggable = true;
                if(paragraph.querySelectorAll('.docelement').length == 0){
                    AddRunTo(paragraph);
                }
            }

            // Задать начальное значение переменной
            async function SetDefaultVariable(variable){
                variable.querySelector('.variable_mean').oninput = function(){
                    for(let span of document.getElementsByClassName('reference_to_data')){
                        CheckOnVariableInSpan(span);
                    }
                    var fixVar = document.querySelector('.FixedVariableContainer[data-idVar="'+ variable.getAttribute('data-idVar') +'"]')
                    if(!fixVar)
                        return
                    fixVar.querySelector('.FixedVariableValue').value = this.value;
                }
            }

            // Вернуться к предыдущей версии
            async function ReturnToLastVersion(){
                var lastVers = lastVersions.pop();
                if( lastVers == undefined){
                    return;
                }
                else{
                    var elem = document.getElementsByClassName("document")[0];
                    while (elem.firstChild) {
                        elem.removeChild(elem.lastChild);
                    }
                    for(let p of lastVers){
                        elem.appendChild(p);
                    }
                    SetDefault();
                }
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
            }

            // Получить сгенерированный id
            function GetId(){
                list = Array.from(document.getElementsByClassName("docelement"));
                if(list.length == 0)
                    return 0;
                list =  list.sort(function(a, b){
                    a_splitted = a.id.split("_");
                    b_splitted = b.id.split("_");
                    a1 = Number(a_splitted[a_splitted.length-1]);
                    b1 = Number(b_splitted[b_splitted.length-1]);
                    if (a1 > b1) return 1;
                    if (a1 == b1) return 0;
                    if (a1 < b1) return -1;
                    });
                var splitted = list[list.length-1].id.split("_");
                return Number(splitted[splitted.length-1]) + 1
            }

            // Добавить текстовый элемент после element
            async function AddRunAfter(element){
                var run = document.createElement("span");
                run.id = "r_"+GetId();
                run.textContent = "";
                run.setAttribute('data-invis', run.textContent);
                SaveLastVersion();
                SetDefaultRun(run);
                await element.parentElement.insertBefore(run, element.nextElementSibling);
                run.style.cssText = element.style.cssText;
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                setActiveElement(run)
                return run;
            }

            // Добавить текстовый элемент до element
            async function AddRunBefore(element){
                var run = document.createElement("span");
                run.id = "r_"+GetId();
                run.textContent = "";
                run.setAttribute('data-invis', run.textContent);
                SaveLastVersion();
                SetDefaultRun(run);
                await element.parentElement.insertBefore(run, element);
                run.style.cssText = element.style.cssText;
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                setActiveElement(run)
                return run;
            }

            // Добавить текстовый элемент в element
            async function AddRunTo(element){
                var run = document.createElement("span");
                run.id = "r_"+GetId();
                run.textContent = "";
                run.setAttribute('data-invis', run.textContent);
                SaveLastVersion();
                SetDefaultRun(run);
                await element.appendChild(run);
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                setActiveElement(run)
                
                return run;
            }

            // Функция sleep иногда полезна
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Добавить параграф после element
            async function AddParagraphAfter(element){
                var paragraph = document.createElement("div");
                paragraph.id = "p_"+GetId();
                SetDefaultPar(paragraph);
                await element.parentElement.insertBefore(paragraph, element.nextElementSibling);
                //await AddRunTo(paragraph);
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                return paragraph;
            }

            // Добавить параграф до element
            async function AddParagraphBefore(element){
                var paragraph = document.createElement("div");
                paragraph.id = "p_"+GetId();
                SetDefaultPar(paragraph);
                element.parentElement.insertBefore(paragraph, element);
                //await AddRunTo(paragraph);
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                return paragraph;
            }

            // Добавить параграф в element
            async function AddParagraphTo(element){
                var paragraph = document.createElement("div");
                paragraph.id = "p_"+GetId();
                SetDefaultPar(paragraph);
                element.appendChild(paragraph);
                //await AddRunTo(paragraph);
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                return paragraph;
            }

            // Обработчик нажатия на кнопку добавления параграфа
            async function ButtonAddParagraph_Click(){
                var activeParagraph = document.querySelectorAll('.selectedParagraph')
                activeParagraph = activeParagraph[activeParagraph.length - 1]
                if(!activeParagraph)
                    await AddParagraphAfter(document_main.lastChild);
                else
                    await AddParagraphAfter(activeParagraph);
            
            }

            // Обработчик нажатия на кнопку добавления текстового элемента
            async function ButtonAddRun_Click(){
                var activeRun = document.querySelector('.selectedRun')
                var activeParagraph = document.querySelector('.selectedParagraph')
                if(activeRun){
                    await AddRunAfter(activeRun);
                }
                else{
                    if(activeParagraph)
                        await AddRunTo(activeParagraph);
                    else
                        await AddRunTo(document_main.lastElementChild);
                }
            }

            async function ButtonAddImage_Click(){
                imageLoadModal.toggle();
            }

            async function AddImageElement(src, idImage){
                var activeParagraph = document.querySelector('.selectedParagraph')
                var newParagraph = await AddParagraphAfter(activeParagraph)
                await newParagraph.insertAdjacentHTML('beforeend', 
                `
                <div id="img_`+idImage+`" class="imageDocElement docelement" data-name="Рисунок `+idImage+`" style="width: 1in;">
                    <img class="imageForDocElement" src="`+src+`" >
                </div>
                `)
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                SetDefaultIMG(newParagraph.querySelector('.imageDocElement'));
            }

            function imageLoadOk(){
                var formData = new FormData();
                var idImage = document.querySelectorAll('.imageDocElement').length + 1
                formData.append('img', $("#imageLoadInput").prop('files')[0]);
                formData.append('id', '{{ Doc.id }}');
                formData.append('idImage', idImage);
                $.ajax({
                    type: "POST",
                    url: "/document/save_doc_image",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res, status, xhr){
                        switch (xhr.status){
                            case 200:
                                AddImageElement(xhr.getResponseHeader('img'), idImage)
                                break;
                            case 304:
                                break;
                        }
                        
                    } 
                });
            }

            // function drawLines(container, pairs, lineContainer) {
            //     // Get the coordinates of the elements in the pairs
            //     const coords = pairs.map(([element1, element2]) => {
            //         const rect1 = element1.getBoundingClientRect();
            //         const rect2 = element2.getBoundingClientRect();
            //         return {
            //         x1: rect1.left + rect1.width / 2,
            //         y1: rect1.top + rect1.height / 2,
            //         x2: rect2.left + rect2.width / 2,
            //         y2: rect2.top + rect2.height / 2
            //         };
            //     });

            //     // Create an SVG element to draw the lines
            //     const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            //     svg.style.position = 'absolute';
            //     svg.style.top = '0';
            //     svg.style.left = '0';
            //     svg.style.width = '100%';
            //     svg.style.height = '100%';

            //     // Draw the lines
            //     coords.forEach((coord) => {
            //         const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            //         line.setAttribute('d', `
            //         M ${coord.x1} ${coord.y1}
            //         L ${coord.x1} ${coord.y2}
            //         L ${coord.x2} ${coord.y2}
            //         `);
            //         line.setAttribute('stroke', 'black');
            //         line.setAttribute('stroke-width', '2');
            //         svg.appendChild(line);
            //     });

            //     // Add the SVG element to the line container
            //     lineContainer.appendChild(svg);
            // }

            function rgbToHex(rgb){
                const hexColor = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                if (hexColor) {
                    const r = parseInt(hexColor[1]);
                    const g = parseInt(hexColor[2]);
                    const b = parseInt(hexColor[3]);
                    const hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                    return hex;
                }
                return rgb
            }

            // Функция, которая применяет стилевые настройки элемента и выставляет эти значения на меню
            async function ApplyStyleText(element){
                fontSizeElement.value = String(parseInt(element.style.fontSize.split("px")[0])-3);
                font_select.value = element.style.fontFamily.replaceAll('"', '');
                font_select.style.fontFamily = element.style.fontFamily;
                if(element.style.backgroundColor != '')
                    colorsBackgroundRun.value = rgbToHex(element.style.backgroundColor);
                else
                    colorsBackgroundRun.value = '#ffffff';
                span_value.disabled = false; 
                span_value.value = element.getAttribute('data-invis');
                    
                if(element.style.fontWeight == "bold"){
                    btn_check_bold.checked = true;
                }
                else{
                    btn_check_bold.checked = false;
                }
                if(element.style.fontStyle == "italic"){
                    btn_check_italic.checked = true;
                }
                else{
                    btn_check_italic.checked = false;
                }
                if(element.style.textDecoration == "underline"){
                    btn_check_underline.checked = true;
                }
                else{
                    btn_check_underline.checked = false;
                }
            }

            // Выставляет в меню настройки отступа
            async function ApplyIndent(element){
                if(element.style.textIndent){
                    IndentElement.value = Number(element.style.textIndent.split('cm')[0]);
                }
                else{
                    IndentElement.value = startIndent;
                    element.style.textIndent = startIndent+"cm";
                }
            }

            // Выставляет в меню настройки интервала
            async function ApplyInterval(element){
                if(element.style.lineHeight){
                    IntervalElement.value = Number(element.style.lineHeight);
                }
                else{
                    IntervalElement.value = startInterval;
                    element.style.lineHeight = startInterval;
                }
            }

            async function ApplyFiltersMenu(element){
                let filtersOfElement = filterManager.FilterHashTable[element.id]
                let radioCattle = document.querySelector('input[name="filterCattle"][value="delFilters"]');
                let radioCase = document.querySelector('input[name="filterCase"][value="delFilters"]');
                let radioRaskrit = document.querySelector('input[name="filterRascrit"][value="delFilters"]');
                radioCattle.checked = true;
                radioCase.checked = true;
                radioRaskrit.checked = true;
                if (filtersOfElement === undefined || filtersOfElement === null) 
                    return
                for(let [key, value] of Object.entries(filtersOfElement)){
                    console.log(key, value)
                    switch (key) {
                        case 'ChangeCattle':
                            let radioCattle = document.querySelector('input[name="filterCattle"][value="'+value+'"]');
                            if(radioCattle === null || radioCattle === undefined)
                                break;
                            radioCattle.checked = true;
                            radioCattle.dispatchEvent(new Event('change'))
                            break;
                        case 'ChangeCase':
                            let radioCase = document.querySelector('input[name="filterCase"][value="'+value+'"]');
                            if(radioCase === null || radioCase === undefined)
                                break;
                            radioCase.checked = true;
                            radioCase.dispatchEvent(new Event('change'))
                            break;
                        case 'Raskrit':
                            let radioRaskrit = document.querySelector('input[name="filterRascrit"][value="'+value+'"]');
                            if(radioRaskrit === null || radioRaskrit === undefined)
                                break;
                            radioRaskrit.checked = true;
                            radioRaskrit.dispatchEvent(new Event('change'))
                            break;
                        default:
                            break;
                    }
                }
            }

            // Декоратор выставления настроек в меню
            async function ApplyMenu(element){
                ApplyStyleText(document.querySelector('.selectedRun'));
                ApplyAlign(document.querySelector('.selectedParagraph'));
                ApplyIndent(document.querySelector('.selectedParagraph'));
                ApplyInterval(document.querySelector('.selectedParagraph'));
                ApplyFiltersMenu(document.querySelector('.selectedRun'));
            }

            // События изменения размера текста в меню
            async function SizeChanged(){
                for(let run of document.querySelectorAll('.selectedRun')){
                    run.style.fontSize = String(parseInt(fontSizeElement.value) + 3) + "px"; 
                }
            }

            // Событие изменения шрифта в меню
            async function FontChanged(){
                font_select.style.fontFamily = font_select.value;
                for(let run of document.querySelectorAll('.selectedRun')){
                    run.style.fontFamily = font_select.value;
                }
            }

            async function backgroundColorChanged(){  
                for(let run of document.querySelectorAll('.selectedRun')){
                    if(colorsBackgroundRun.value == '#FFFFFF')
                        run.style.backgroundColor = '';
                    else
                        run.style.backgroundColor = colorsBackgroundRun.value;
                }
            }

            // Событие изменения отступа
            async function IndentChanged(){
                var indent = IndentElement.value;
                for(let paragraph of document.querySelectorAll('.selectedParagraph'))
                    paragraph.style.textIndent = Number(indent) + 'cm';
            }

            // Событие изменения интервала
            async function IntervalChanged(){
                var interval = IntervalElement.value;
                for(let paragraph of document.querySelectorAll('.selectedParagraph'))
                    paragraph.style.lineHeight = Number(interval);
            }

            // Событие изменения цвета радиогруппы
            async function InputColor(colorInput){
                for(let child of colorInput.parentNode.nextElementSibling.firstElementChild.children){
                    document.querySelector('.tree_element[data-idElement="'+ child.getAttribute('data-idElement') +'"]').style.backgroundColor = colorInput.value;
                }
            }

            // Функция создания элемента Радиогруппа
            function createRadioGroup(name, color1){
                var li = document.createElement('li');
                var div = document.createElement('div');
                var divul = document.createElement('div');
                var divTextColor = document.createElement('div');
                var color = document.createElement('input');
                var span = document.createElement('span');
                var ul = document.createElement('ul');

                divTextColor.classList.add('containerTextColorRadioGroup');
                color.type = 'color';
                if(color1){
                    color.value = color1;
                }
                else
                    color.value = '#97c0ff';

                color.oninput = (evt)=>{
                    InputColor(color);
                }
                ul.classList.add('list-group');
                divul.id = 'radioGroup' + modal_radioGroup_list.children.length;
                li.classList.add('list-group-item');
                li.classList.add('radioGroups');
                span.contentEditable = true;
                if(name)
                    span.textContent = name;
                else
                    span.textContent = "РадиоГруппа" + modal_radioGroup_list.children.length;
                divul.classList.add('ulContainerRadioGroup');
                

                divTextColor.appendChild(span);
                divTextColor.appendChild(color);
                div.appendChild(divTextColor);
                divul.appendChild(ul);
                div.appendChild(divul);
                li.appendChild(div)
                return li;
            }

            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';

                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }

                return color;
            }

            // Функция добавления радиогруппы
            async function addRadioGroup(){
                const length = modal_radioGroup_list.children.length
                var color = getRandomColor()
                var id = 'radioGroup' + length
                var name = 'Новая альтернатива' + length
                modal_radioGroup_list.insertAdjacentHTML('beforeend', `
                <div class="RadioGroup" id="` + id + `" onclick="radioGroupClick(event);">
                    <div class="containerTextColorRadioGroup">
                        <input onchange="RadioGroupColorChanged(event);" type="color" value="`+ color +`">
                        <span contenteditable="true" oninput="radioGroupNameChanged(event);">`+ name  +`</span>
                    </div>
                </div>
                `)
                document.querySelector(".dropdown-menu").insertAdjacentHTML('beforeend', `
                    <li class="dropdownRadioGroup" onclick="radioGroupClickInstrument(event)" data-idRadioGroup="`+ id +`" type="button"><a class="dropdown-item" style="background-color:`+ color +`"></a><span>`+name+`</span></li>
                `)
            }

            function setRadio(element, radio){
                var tree_element = document.querySelector('.tree_element[data-idElement="'+ element.id +'"]');
                if(!tree_element)
                    return
                let tree_element_checkbox = tree_element.querySelector('.hideCheckbox')
                if (tree_element_checkbox){
                    tree_element_checkbox.type = 'radio';
                    tree_element_checkbox.name = radio.id;
                    if(tree_element_checkbox !== null && tree_element_checkbox !== undefined)
                        tree_element_checkbox.dispatchEvent(new Event('change'));
                }
                let tree_element_radioGroupIndicator = tree_element.querySelector('.radioGroupIndicator')
                if (tree_element_radioGroupIndicator){
                    tree_element_radioGroupIndicator.style.backgroundColor = radio.querySelector('input').value;
                    tree_element_radioGroupIndicator.classList.remove('invisible')
                }
                element.classList.add('selectedRadioGroupDocelement');
                element.style.borderLeftColor = radio.querySelector('input').value
            }

            function unsetRadio(element, radio){
                var tree_element = document.querySelector('.tree_element[data-idElement="'+ element.id +'"]');
                if(!tree_element)
                    return
                let tree_element_checkbox = tree_element.querySelector('.hideCheckbox')
                if (tree_element_checkbox){
                    tree_element_checkbox.type = 'checkbox';
                    tree_element_checkbox.name = '';
                    console.log(tree_element_checkbox.checked)
                    if(tree_element_checkbox !== null && tree_element_checkbox !== undefined)
                        tree_element_checkbox.dispatchEvent(new Event('change'));
                }
                let tree_element_radioGroupIndicator = tree_element.querySelector('.radioGroupIndicator')
                if (tree_element_radioGroupIndicator){
                    tree_element_radioGroupIndicator.style.backgroundColor = radio.querySelector('input').value;;
                    tree_element_radioGroupIndicator.classList.add('invisible');
                }
                element.classList.remove('selectedRadioGroupDocelement');
                element.style.borderLeftColor = ''  
            }

            async function radioGroupClick(event){
                let radioGroup = event.target.closest('.RadioGroup')
                for(let vari of document.querySelectorAll('.selectedRadioGroup')){
                    vari.classList.remove('selectedRadioGroup')
                }
                for(let sel of document_main.querySelectorAll('.selected')){
                    sel.setAttribute('data-idRadioGroup', radioGroup.id)
                    if(radioGroup.id == "radioGroup-1")
                        unsetRadio(sel, radioGroup)
                    else
                        setRadio(sel, radioGroup)
                }
                radioGroup.classList.add('selectedRadioGroup');
            }

            async function radioGroupClickInstrument(event){
                let radioInstrument = event.target.closest('.dropdownRadioGroup') 
                let radioGroup = document.querySelector('#'+radioInstrument.getAttribute('data-idRadioGroup'))
                for(let vari of document.querySelectorAll('.selectedRadioGroup')){
                    vari.classList.remove('selectedRadioGroup')
                }
                for(let sel of document_main.querySelectorAll('.selected')){
                    sel.setAttribute('data-idRadioGroup', radioGroup.id)
                    if(radioGroup.id == "radioGroup-1")
                        unsetRadio(sel, radioGroup)
                    else
                        setRadio(sel, radioGroup)
                }
                radioGroup.classList.add('selectedRadioGroup');
                document.querySelector('#btnRadioInstruments').setAttribute('data-idRadioGroup', radioGroup.id)
                document.querySelector('#btnRadioInstruments').style.backgroundColor = radioGroup.querySelector('input').value
            }

            // Функция переводит ряды таблицы в JSON
            function TableRowToJSON(elem, id){
                var tds = [];
                for(let child of elem.children){
                    tds.push(TableColumnToJSON(child, tds.length));
                }
                let op = Object.fromEntries(Object.entries(elem.style).filter(([_, v]) => v != ''));
                return JSON.stringify({'id': "tr_"+id, 'childs': tds, 'style': op});
            }

            // Функция переводит колонки таблицы в JSON
            function TableColumnToJSON(elem, id){
                let o = Object.fromEntries(Object.entries(elem.style).filter(([_, v]) => v != ''));
                
                return JSON.stringify({'text': elem.value, 'id': "tc_" + id, 'style': o , 'paragraph': ParagraphToJSON(elem.firstElementChild, 0)});
            }

            // Функция переводит таблицы в JSON
            function TableToJSON(elem, id){
                var trs = [];
                var grid;
                for(let child of elem.children){
                    if(child.nodeName == "TABLE"){
                        for(let child1 of child.children){
                            for(let child2 of child1.children){
                                if(child2.nodeName == "TR"){
                                    trs.push(TableRowToJSON(child2, trs.length));
                                }
                            }
                        }
                    }
                    if(child.nodeName == "INPUT"){
                        grid = child.value;
                    }
                }
                let op = Object.fromEntries(Object.entries(elem.style).filter(([_, v]) => v != ''));
                return JSON.stringify({'id': elem.id, 'childs': trs, 'style': op, 'tableGrid': grid});
            }

            // Функция переводит параграф в JSON
            function ParagraphToJSON(elem, id){
                var chil = [];
                for(let child of elem.children){
                    if(child.classList.contains("docelement_copy"))
                        continue
                    if(child.classList.contains('runs')){
                        chil.push(ChildrenToJSON(child, chil.length));
                    }
                    else if(child.classList.contains('imageDocElement')){
                        chil.push(ImageToJSON(child.querySelector('img'), chil.length));
                    }
                }
                let op = Object.fromEntries(Object.entries(elem.style).filter(([_, v]) => v != ''));
                if(elem.style['textIndent']){
                    op['textIndent'] = elem.style['textIndent'];
                }
                return JSON.stringify({'id': elem.id, 
                'data-name': elem.getAttribute('data-name'), 
                'data-idRadioGroup': elem.getAttribute('data-idRadioGroup'), 
                'class': 'paragraph', 
                'childs': chil, 
                'style': op, 
                'hidden': elem.hidden, 
                'userCanSee': elem.classList.contains('userCanSeeInTree')});
            }

            function addSpaceIfNecessary(elem) {
                const nextElement = elem.nextElementSibling;
                const nextText = nextElement ? nextElement.textContent.trim() : '';
                let text = elem.textContent;
                const onlySpaces = text.trim() === '' && text !== '';
                const punctuationMarks = ['.', ',', '!', '?', ';', ':', ')'];
                const lastChar = text.trim()[text.trim().length - 1];

                if (nextText && !punctuationMarks.includes(nextText[0]) && lastChar !== '(') {
                    if (onlySpaces) {
                        return text;
                    } else {
                        return text.trim() + ' ';
                    }
                }
                return text.trim();
            }

            // Функция переводит элементы внутри параграфа в JSON
            function ChildrenToJSON(elem, id){
                let o = Object.fromEntries(Object.entries(elem.style).filter(([_, v]) => v != ''));
                return JSON.stringify({'text': changeQuotes(addSpaceIfNecessary(elem)), 
                'data-invis': elem.getAttribute('data-invis'), 
                'data-name': elem.getAttribute('data-name'), 
                'data-idRadioGroup': elem.getAttribute('data-idRadioGroup'), 
                'class': elem.classList[0], 
                'id': elem.id, 'style': o , 'attrib': elem.id, 'hidden': elem.hidden, 'userCanSee': elem.classList.contains('userCanSeeInTree')});
            }

            function ImageToJSON(elem, id){
                const rect = elem.getBoundingClientRect()
                elem.parentElement.style.width = rect.width * 0.2636;
                elem.parentElement.style.height = rect.height * 0.2636;
                let o = Object.fromEntries(Object.entries(elem.style).filter(([_, v]) => v != ''));
                
                return JSON.stringify({'src': elem.src, 
                'data-name': elem.getAttribute('data-name'),
                'data-idRadioGroup': elem.getAttribute('data-idRadioGroup'),  
                'class': 'img', 'id': elem.parentElement.id, 'style': o , 'hidden': elem.hidden, 'userCanSee': elem.classList.contains('userCanSeeInTree'), 'width': rect.width * 0.2636, 'height': rect.height * 0.2636});
            }

            // Функция переводит сохранённые элементы в JSON
            // function SavedElementToJSON(list_elem, id1){
            //     var element = list_elem.firstChild.children[1];
            //     var inner = list_elem.firstChild.children[0].textContent;
            //     var id = list_elem.getAttribute('data-idDB');
            //     var lst = {};
            //     lst['id'] = id;
            //     lst['name'] = inner;
            //     if(element.classList.contains("paragraph")){
            //         lst['json'] = ParagraphToJSON(element, id1);
            //     }
            //     else if(element.classList.contains("tables")){
            //         lst['json'] = TableToJSON(element, id1);
            //     }
            //     else if(element.classList.contains("runs")){
            //         lst['json'] = ChildrenToJSON(element, id1);
            //     }
            //     return lst;
            // }

            // // Функция переводит список сохранённых элементов в JSON
            // function ListSavedToJSON(){
            //     var chil = [];
            //     for(let list_elem of list_saved_sp.children)
            //         chil.push(SavedElementToJSON(list_elem, chil.length));
            //     return chil;
            // }

            // Функция переводит переменную в JSON
            function VariableToJSON(variable){
                var name = variable.querySelector('.variable_name').textContent;
                var value = variable.querySelector('.variable_mean').value;
                if(variable.getAttribute('data-idVar') == '-1')
                    var id = variable.getAttribute('data-idVar');
                else
                    var id = variable.getAttribute('data-idVar').split(';')[1];
                var lst = {};
                lst['id'] = id;
                lst['name'] = name;
                lst['value'] = value;
                lst['id_doc'] = "{{ Doc.id }}";
                return lst;
            }

            // Функция переводит все переменные в JSON
            function VariablesToJSON(){
                var chil = [];
                for(let variable of document.getElementsByClassName('variable'))
                    chil.push(VariableToJSON(variable));
                return chil;
            }

            // Функция переводит членов радиогруппы в JSON
            // function RadioGroupMemberToJSON(child){
            //     var lst = {};
            //     lst['data-idElement'] = child.getAttribute('data-idElement');
            //     return lst;
            // }

            // Функция переводит радиогруппу в JSON
            function RadioGroupToJSON(radioGroup){
                var lst = {};
                var childs = [];

                lst['name'] = radioGroup.querySelector('span').textContent;
                lst['color'] = radioGroup.querySelector('input').value;
                lst['id'] = radioGroup.id
                // for(let child of radioGroup.firstElementChild.lastElementChild.firstElementChild.children){
                //     childs.push(RadioGroupMemberToJSON(child))
                // }
                // lst['childs'] = childs;
                return lst;
            }

            // Функция переводит все радиогруппы в JSON
            function RadioGroupsToJSON(){
                var lst = {};
                var childs = [];

                for(let radioGroup of document.querySelectorAll('.RadioGroup')){
                    if(radioGroup.id == 'radioGroup-1')
                        continue
                    childs.push(RadioGroupToJSON(radioGroup));
                }
                lst['childs'] = childs;
                return lst;
            }

            // Функция переводит закреплённые переменные в JSON
            function GetFixedVariables(){
                var childs = [];
                for(let fixVar of document.querySelectorAll('.FixedVariableContainer')){
                    childs.push({'id': fixVar.getAttribute('data-idVar')});
                }
                return childs;
            }

            // Функция создаёт JSON всего проекта документа
            function CreateJSON(){
                unsetActiveElements()
                body = document.getElementsByClassName("document")[0];
                var jsondict = {};
                var chil = [];
                for(let child of body.children){
                    if(child.classList.contains("docelement_copy"))
                        continue
                    if(child.classList.contains("paragraph")){
                        chil.push(ParagraphToJSON(child, chil.length));
                    }
                    else if(child.classList.contains("tables")){
                        chil.push(TableToJSON(child, chil.length));
                    }
                }
                jsondict['elements'] = chil;
                jsondict['sectPr'] = document.getElementById("sectPr").value;
                jsondict['doc_name'] = doc_name.textContent;
                jsondict['radioGroups'] = RadioGroupsToJSON();
                jsondict['fixedVariable'] = GetFixedVariables();
                images = {};
                for (const [index, node] of document.querySelectorAll('.paragraph').entries()) {
                    if(node.querySelector('img')){
                        const rect = node.querySelector('img').getBoundingClientRect()
                        images[index] = {'src': node.querySelector('img').src, 'width': rect.width * 0.2636, 'height': rect.height * 0.2636}
                        
                    }
                }
                jsondict['images'] = images;
                jsondict['filters'] = filterManager.FilterHashTable
                jsondict['events'] = eventManager.eventHashTable
                jsondict['cycles'] = cycleManager.CycleHashTable
                return jsondict;
            }



            //Функция удаляет переменную из базы данных при помощи POST-запроса
            async function DeleteVariable(evt){
                let variable = evt.target.closest('.variable')
                if(variable.getAttribute('data-idVar') == -1){
                    await variable.parentNode.removeChild(variable);
                    UpdateVariableList();
                } 
                else{
                    let variable_id = variable.getAttribute('data-idVar')
                    $.ajax({
                        type: "POST",
                        url: "/document/variable/delete",
                        data: JSON.stringify({'id': variable_id.split(';')[1]}),
                        contentType: "application/json; charset=utf-8",
                        success: function(res, status, xhr){
                            try {
                                DeleteFixedVariable(variable) 
                            } catch (error) {
                                
                            }
                            variable.parentNode.removeChild(variable);
                            UpdateVariableList(); 
                            for(let elem of document.querySelectorAll('.docelement.variable_ref[data-idVar="'+ variable_id +'"]')){
                                DeleteElement(elem)
                            }
                        }
                    });
                }
            }


            async function elementHiddenDispatchEvent(elem){
                if(elem.hidden){
                    eventManager.eventDispatch(elem.id, 'hidden');
                }
                else{
                    eventManager.eventDispatch(elem.id, 'unhidden');
                }
            }

            async function TreeElementChange(tree_element){                
                if(tree_element === undefined || tree_element === null)
                    return
                
                var elem = document.getElementById(tree_element.getAttribute('data-idElement')); 
                if(elem === undefined || elem === null)
                    return

                var checked = tree_element.querySelector('.hideCheckbox').checked;
                elem.hidden = !checked;
                elementHiddenDispatchEvent(elem)
                // other.dispatchEvent(new Event('change'));
                if(tree_element.querySelector('ul')){
                    for(let tree_elem_child of tree_element.querySelector('ul').children){
                        let hide = tree_elem_child.querySelector('.hideCheckbox')
                        hide.readonly = !checked;
                        hide.checked = checked;
                        hide.dispatchEvent(new Event('change'));
                    }
                }
            }

            // Функция реагирует на клик в радиогруппе
            async function RadioInputChanged(evt){
                for(let other of document.querySelectorAll('input[name="'+ evt.target.name +'"]')){
                    TreeElementChange(other.closest('.tree_element'));
                }
            }

            function TreeElementInput1OnChange(evt){
                let tree_element = evt.target.closest('.tree_element');
                var hide = tree_element.querySelector('.hideCheckbox')
                TreeElementChange(tree_element);
                if(hide.type == 'radio'){
                    RadioInputChanged(evt);
                }
            }

            

            async function CheckUserCanSeeFlags(tree_element){
                var element = document.getElementById(tree_element.getAttribute('data-idElement'))
                var label_eye = tree_element.querySelector('.setUserCheckboxLabel > i');
                if(element.classList.contains('userCanSeeInTree')){
                    tree_element.classList.add('userCanSee');  
                    label_eye.setAttribute('class',"fa-regular fa-eye fa-lg")
                    tree_element.querySelector('.setUserCheckbox').checked = true
                }
                else{
                    tree_element.classList.remove('userCanSee');
                    label_eye.setAttribute('class',"fa-regular fa-eye-slash fa-lg")
                    tree_element.querySelector('.setUserCheckbox').checked = false
                }
            }

            async function ChangeUserCanSee(tree_element, checked){
                var element = document.getElementById(tree_element.getAttribute('data-idElement'))
                var label_eye = tree_element.querySelector('.setUserCheckboxLabel > i');
                tree_element.querySelector('.setUserCheckbox').checked = checked
                if(checked){
                    tree_element.classList.add('userCanSee');   
                    element.classList.add('userCanSeeInTree');            
                    label_eye.setAttribute('class',"fa-regular fa-eye fa-lg")
                }
                else{
                    tree_element.classList.remove('userCanSee');
                    element.classList.remove('userCanSeeInTree');
                    label_eye.setAttribute('class',"fa-regular fa-eye-slash fa-lg")
                }
            }

            function TreeElementInput2OnChange(evt){
                evt.stopPropagation();
                var tree_element = evt.target.closest('.tree_element')
                ChangeUserCanSee(tree_element, evt.target.checked)
                var tree_element_parent = tree_element.parentNode.closest('.tree_element')
                if(tree_element_parent && evt.target.checked)
                    ChangeUserCanSee(tree_element_parent, evt.target.checked)
                for(let tree_elem of tree_element.querySelectorAll('.tree_element')){
                    ChangeUserCanSee(tree_elem, evt.target.checked)
                }
                
            }

            function TreeElementSpanOnInput(evt){
                evt.preventDefault();
                var element = document.getElementById(evt.target.closest('.tree_element').getAttribute('data-idElement'));
                element.setAttribute('data-name', evt.target.textContent);
                //UpdateTreeElementInRadio(evt.target.closest('.tree_element').getAttribute('data-idElement'));
            }

            function TreeElementDblClick(evt){
                evt.stopPropagation();
                let tree_element = evt.target.closest('.tree_element');
                var element = document.getElementById(tree_element.getAttribute('data-idElement'));
                
                setActiveElement(element);
                goToDeveloperOption('optionTreeElement')
            }

            function TreeElementBtnlClick(evt){
                evt.stopPropagation();
                evt.preventDefault();
                let tree_element = evt.target.closest('.tree_element');
                let ul_tree_element = tree_element.querySelector('ul');
                let caret = tree_element.querySelector('.tree_element_caret i')
                $(ul_tree_element).collapse('toggle');
                if(caret.classList.contains('fa-caret-right')){
                    caret.classList.remove('fa-caret-right');
                    caret.classList.add('fa-caret-down');
                }
                else{
                    caret.classList.remove('fa-caret-down');
                    caret.classList.add('fa-caret-right');
                }
            }

            function fromHTML(html, trim = true) {
                // Process the HTML string.
                html = trim ? html : html.trim();
                if (!html) return null;

                // Then set up a new template element.
                const template = document.createElement('template');
                template.innerHTML = html;
                const result = template.content.children;

                // Then return either an HTMLElement or HTMLCollection,
                // based on whether the input HTML had one or more roots.
                if (result.length === 1) return result[0];
                return result;
            }

            //Функция создаёт элемент для дерева
            function CreateTreeElement(element, name) {
                const hasDocElements = element.querySelectorAll('.docelement').length > 0;
                const variableRef = element.classList.contains('variable_ref');
                const variableId = variableRef ? element.getAttribute('data-idVar') : null;
                const variable = variableRef ? document.querySelector('.variable[data-idVar="'+ variableId +'"]') : null;
                const userCanSee = element.classList.contains('userCanSee');
                const hiddenStatus = !element.hidden;
                const tree_element_html = `
                    <li class="list-group-item tree_element${userCanSee ? ' userCanSee' : ''}" ondblclick="TreeElementDblClick(event);" data-idelement="${element.id}" style="background-color: rgb(255, 255, 255);">
                        <div class="tree_element_container">
                            <input class="form-check-input me-1 hideCheckbox" onchange="TreeElementInput1OnChange(event);" type="checkbox" name="${name}" value="${element.id}" ${hiddenStatus ? 'checked' : ''}>
                            <input class="btn-check setUserCheckbox" onchange="TreeElementInput2OnChange(event);" type="checkbox" id="checkView;${element.id}">
                            <label class="setUserCheckboxLabel" for="checkView;${element.id}" type="button">
                                <i class="fa-regular fa-${userCanSee ? 'eye' : 'eye-slash'} fa-lg"></i>
                            </label>
                            <div class="radioGroupIndicator invisible"></div>
                            <span contenteditable="true" class="tree_element_label" oninput="TreeElementSpanOnInput(event);">${name}</span>
                            <a class="btn btn-labeled tree_element_caret" onclick="TreeElementBtnlClick(event);" style="display: ${hasDocElements ? '' : 'none'};"><i class="fa-solid fa-caret-right"></i></a>
                        </div>
                        ${variableRef ? `
                        <div class="variable variable_in_tree" data-idVar="`+variableId+`_tree" ondblclick="SelectVar(event);">
                            <span class="variable_name">`+variable.querySelector('.variable_name').textContent+`</span>
                            <input type="${variable.querySelector('.variable_mean').type}" class="variable_mean" oninput="onChangeVariableOriginal(event);" value="${variable.querySelector('.variable_mean').value}">
                        </div>
                            ` : ''}
                    </li>
                `;
                return fromHTML(tree_element_html);
            }

            // Функция обновляет элемент в дереве
            async function UpdateTreeElement(tree_element){
                var element = document_main.querySelector('#'+tree_element.getAttribute('data-idElement'));
                var name = "";
                var name = "";
                if(element.getAttribute('data-name').trim() == "" || element.getAttribute('data-name').trim() == 'null'){
                    if(element.classList.contains('paragraph')){
                        for(let run of element.querySelectorAll('.docelement')){
                            name += run.textContent + " ";
                        }
                    }
                    else
                        name = element.textContent
                }
                else{
                    name = element.getAttribute('data-name')
                }
                tree_element.querySelector('input').checked = !element.hidden;
                tree_element.querySelector('.tree_element_label').textContent = name;
                var tree_element_btn = document.createElement('a');
                if(element.querySelectorAll('.docelement').length > 0 && !element.querySelector('.list_caret_btn')){
                    tree_element_btn.classList.add('btn');
                    tree_element_btn.classList.add('btn-labeled');
                    tree_element_btn.classList.add('list_caret_btn');
                    var i = document.createElement('i')
                    i.classList.add('fa-solid');
                    i.classList.add('fa-caret-down');
                    tree_element_btn.appendChild(i);
                    tree_element_btn.addEventListener('click', (evt)=>{
                        evt.stopPropagation();
                        evt.preventDefault();
                        var elem = document.querySelector('.tree_element[data-idElement="'+ element.id +'"] ul');
                        $('.tree_element[data-idElement="'+ element.id +'"] ul').collapse('toggle');
                        if(tree_element_btn.querySelector('i').classList.contains('fa-caret-right')){
                            tree_element_btn.querySelector('i').classList.remove('fa-caret-right');
                            tree_element_btn.querySelector('i').classList.add('fa-caret-down');
                        }
                        else{
                            tree_element_btn.querySelector('i').classList.remove('fa-caret-down');
                            tree_element_btn.querySelector('i').classList.add('fa-caret-right');
                        }
                    });
                }
                else{
                    tree_element_btn.style.display = 'none';
                }
                CheckUserCanSeeFlags(tree_element)
                //UpdateTreeElementInRadio(tree_element.getAttribute('data-idElement'));
            }

            // Функция удаляет элемент в дереве
            async function DeleteTreeElement(element){
                var tree_element = document.querySelector('.tree_element[data-idElement="'+ element.id +'"]')
                if(tree_element){
                    tree_element.parentElement.removeChild(tree_element);
                }
            }
            
            function OptionContainerIsClicked(evt){
                evt.stopPropagation();
                evt.preventDefault();
                let optionContainer = evt.target.closest('.optionContainer')
                let input = optionContainer.querySelector('.optionInput')
                input.checked = true
                input.dispatchEvent(new Event('change'))
            }

            // Функция заполняет дерево
            async function FillTree(parent, childs){
                for(let child of childs){
                    var element = document.querySelector('.tree_element[data-idElement="'+ child.id +'"]')
                    if(!element){
                        var name = "";
                        if(child.getAttribute('data-name').trim() == "" || child.getAttribute('data-name').trim() == 'null'){
                            if(child.classList.contains('paragraph')){
                                for(let run of child.querySelectorAll('.docelement')){
                                    name += run.textContent + " ";
                                }
                            }
                            else
                                name = child.textContent
                        }
                        else{
                            name = child.getAttribute('data-name') 
                        }
                        child.setAttribute('data-name', name)
                        var tree_element = CreateTreeElement(child, name)
                        // if(!child.getAttribute('data-name'))
                        //     var tree_element = CreateTreeElement(child, 'Элемент ' + child.id);
                        // else
                        //     var tree_element = CreateTreeElement(child, child.getAttribute('data-name'));
                        if(child.querySelectorAll('.docelement').length > 0){
                            var ul = document.createElement('ul');
                            ul.classList.add('list-group-flush');
                            ul.classList.add('collapse')
                            ul.classList.add('show')
                            FillTree(ul, child.querySelectorAll('.docelement'));
                            tree_element.appendChild(ul);
                            
                        }
                        if (child.nextElementSibling){
                            var element_before_add = document.querySelector('.tree_element[data-idElement="'+ child.nextElementSibling.id +'"]')
                            if(element_before_add)
                                parent.insertBefore(tree_element, element_before_add)
                            else
                                parent.appendChild(tree_element);
                        }
                        else{
                            parent.appendChild(tree_element);
                        }
                        CheckUserCanSeeFlags(tree_element)
                        //modal_radioGroup_treeElements_list.appendChild(CreateTreeElementInRadio(child.id));
                    }
                    else{
                        UpdateTreeElement(element);
                        if(child.children.length > 0){
                            var ul = element.querySelector('ul');
                            if(!ul){
                                ul = document.createElement('ul');
                                ul.classList.add('list-group-flush');
                                element.appendChild(ul);
                            }
                            FillTree(ul, child.querySelectorAll('.docelement'));
                        }
                    }
                }
                switchAdminMode(document.querySelector('#tree_develop').checked);
            }

            // Функция создаёт элемент в списке элементов для радиогрупп
            // function CreateTreeElementInRadio(id){
            //     var li = document.createElement('li');
            //     var span = document.createElement('span');
            //     var child = document.querySelector('#'+id);
            //     var name = "";
            //     if(child.getAttribute('data-name').trim() == "" || child.getAttribute('data-name').trim() == 'null'){
            //         if(child.classList.contains('paragraph')){
            //             for(let run of child.querySelectorAll('.docelement')){
            //                 name += run.textContent + " ";
            //             }
            //         }
            //         else
            //             name = child.textContent
            //     }
            //     else{
            //         name = child.getAttribute('data-name')
            //     }
            //     span.textContent = name;
            //     span.classList.add('treeElementInRadioLabel');
            //     li.setAttribute('data-idElement', id);
            //     li.classList.add('list-group-item');
            //     li.classList.add('TreeElementInModalList');
            //     li.draggable = true;
            //     li.appendChild(span);
            //     return li;
            // }

            // Функция обновляет элементы дерева в списке радиогрупп
            // async function UpdateTreeElementInRadio(id){
            //     var treeElementInRadio = document.querySelector('.TreeElementInModalList[data-idElement="'+ id +'"]');
            //     var treeElement = document.querySelector('.tree_element[data-idElement="'+ id +'"]')
            //     treeElementInRadio.firstElementChild.textContent = treeElement.querySelector('.tree_element_label').textContent;
            // }

            // Функция удаляет элементы дерева в списке радиогрупп
            // async function DeleteTreeElementInRadio(id){
            //     var treeElementInRadio = document.querySelector('.TreeElementInModalList[data-idElement="'+ id +'"]');
            //     treeElementInRadio.parentElement.removeChild(treeElementInRadio);
            // }

            // События на изменение текста в поле изменения текста
            span_value.oninput = function(event){
                var span =  document.querySelector('.selectedRun');
                if(!span.classList.contains('reference_to_data')){
                    span.textContent = span_value.value;
                    span.setAttribute('data-invis', span_value.value);
                }
                CheckOnVariableInSpan(span);
            }

            // Функция оповещает пользователя, что сохранение прошло успешно
            async function SaveComplete(){
                console.log("Сохранение прошло успешно");
                save_complete.style.display = "flex";
                if("{{ type }}" == "1"){
                    document.location.href = "/"
                }
                setTimeout(SaveNotComplete, 2000);
            }

            // Функция оповещает, что сохранение не было
            async function SaveNotComplete(){
                save_complete.style.display = "none";
            }
        

            // Функция сохраняет документ и обновляет файл на сервере
            async function UpdateFile(download){
                unsetActiveElements();
                //SaveListSaved();
                SaveVariables();
                await filterManager.acceptAllFilters();
                fetch(`/document/update?id={{ Doc.id }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify(CreateJSON())
                }).then(response => {
                    if (response.ok) {
                        SaveComplete();
                        if (download) {
                            window.open(`/document/download?id={{ Doc.id }}`, '_blank');
                        }
                        // TakeScreenShot();
                    } else {
                        throw new Error('HTTP error ' + response.status);
                    }
                }).catch(error => {
                    if (error.status === 304) {
                        const messageOfError = decodeURIComponent(escape(error.getResponseHeader('MessageOfError')));
                        const typeOfError = decodeURIComponent(escape(error.getResponseHeader('TypeOfError')));
                        TextOfError.textContent = messageOfError;
                        TypeOfError.textContent = typeOfError;
                        errorModal.toggle();
                    } else {
                        console.error('Error:', error);
                    }
                });
            }

            // Функция удаляет текстовый элемент и перебрасывает на предыдущий
            async function DeleteElement(elem){
                let previousElement = elem.previousElementSibling;
                let parent = elem.parentElement;
                try {
                    unsetActiveElements();
                    DeleteTreeElement(elem);
                    parent.removeChild(elem);
                    try {
                        if(parent.children.length == 0){
                            let previousPar = parent.previousElementSibling;
                            DeleteTreeElement(parent);
                            parent.parentElement.removeChild(parent);
                            await sleep(50); //Нужно небольшое ожидание, иначе не успевает удалиться элемент
                            setActiveElement(previousPar.lastElementChild);
                        }
                        // Если предыдущего элемента нет, значит нужно переключиться на предыдущий параграф
                        else if(!previousElement){
                            let previousPar = parent.previousElementSibling;
                            await sleep(50);
                            setActiveElement(previousPar.lastElementChild);
                        }
                        else{
                            await sleep(50);
                            setActiveElement(previousElement);
                        }
                    } catch (error) {
                        
                    }// Если параграф пустой после удаления то удаляем его тоже а выделение перемещаем на предыдущий параграф
                    
                    return true
                } catch (error) {
                    console.log(error)
                    return false
                }
                
            }

            // Функция для разделения текстового элемента на 3 части по выделению (слева от выделенного, выделенное, справа от выделенного)
            function splitRun(text){
                var selectedRun = document.querySelector('.selectedRun');
                var indexStart = text.anchorOffset;
                var indexEnd = text.extentOffset;
                if(selectedRun){
                    var run_splitted = [selectedRun.textContent.substring(0, indexStart), selectedRun.textContent.substring(indexEnd)];
                    var run1 = selectedRun.cloneNode(true);
                    var run2 = selectedRun.cloneNode(true);
                    run1.textContent = text;
                    run2.textContent = run_splitted[1];
                    selectedRun.textContent = run_splitted[0];
                    run1.setAttribute('data-invis', text);
                    run2.setAttribute('data-invis', run_splitted[1]);
                    run1.id = "r_"+GetId();
                    run2.id = "r_"+GetId();
                    run1.contentEditable = false;
                    run2.contentEditable = false;
                    SetDefaultRun(run1);
                    SetDefaultRun(run2);
                    selectedRun.parentElement.insertBefore(run2, selectedRun.nextElementSibling);
                    selectedRun.parentElement.insertBefore(run1, selectedRun.nextElementSibling);  
                    unsetActiveElements();
                    setActiveElement(selectedRun);
                }
            }

            // Функция для объединения текстовых элементов в одно
            // function JoinRuns(){
            //     if(activeElements.length < 1)
            //         return;
            //     var firstRun = activ;
            //     for()
            // }

            // Фукнция для получения позиции каретки
            function getCaretPosition(editableDiv) {
                var caretPos = 0,
                    sel, range;
                if (window.getSelection()) {
                    sel = window.getSelection();
                    if (sel.rangeCount) {
                        range = sel.getRangeAt(0);
                        if (range.commonAncestorContainer.parentNode == editableDiv) {
                            caretPos = range.endOffset;
                        }
                    }
                } else if (document.selection && document.selection.createRange) {
                    range = document.selection.createRange();
                    if (range.parentElement() == editableDiv) {
                        var tempEl = document.createElement("span");
                        editableDiv.insertBefore(tempEl, editableDiv.firstChild);
                        var tempRange = range.duplicate();
                        tempRange.moveToElementText(tempEl);
                        tempRange.setEndPoint("EndToEnd", range);
                        caretPos = tempRange.text.length;
                    }
                }
                return caretPos;
            }

            // Функция прячет контекстное меню на правую кнопку мыши
            function HideContextMenu(){
                context_menu.style.display = 'none';
            }

            // Функция отображает контекстное меню на правую кнопку мыши
            function ShowContextMenu(event){
                event.preventDefault();
                targetRun = event.target.closest('.runs')
                if(targetRun){
                    advContextElement.style.display = ''
                    tempElement = targetRun
                }
                else{
                    advContextElement.style.display = 'none'
                }
                if(context_menu.style.display == 'block')
                    HideContextMenu();
                else{
                    context_menu.style.display = 'block';
                    context_menu.style.left = event.pageX + "px";
                    context_menu.style.top = event.pageY + "px";          
                }
            }

            // Обновление списка быстрого доступа к переменным
            function UpdateVariableList(){
                variable_list.innerHTML = "";
                var variables = document.querySelectorAll('.variable')
                var objects_params = document.querySelectorAll('.obj_parameter')
                for(let vari of variables){
                    var opt = document.createElement('option');
                    opt.value = '{: ' + vari.querySelector('.variable_name').textContent + ' :}';
                    opt.classList.add('option_variable_list');
                    variable_list.appendChild(opt);
                }
                for(let objects_param of objects_params){
                    var opt = document.createElement('option');
                    opt.value = '{: ' + objects_param.getAttribute('data-paramName') + ' :}';
                    opt.classList.add('option_objects_param_list');
                    variable_list.appendChild(opt);
                }
            }

            // Получаем переменные из JSON
            function VariableFromJSON(data) {
                var jsonp = JSON.parse(data);
                for(let [key, value] of Object.entries(jsonp)){
                    CreateNewVariable(key, value.split(':')[0], value.split(':')[1], 'VariableMyself');
                }
            }

            function onInputVariableName(event){
                UpdateVariableList();
                var spans = document_main.getElementsByClassName('runs');
                for(let span of spans){
                    CheckOnVariableInSpan(span);
                }
            }

            function onChangeVariableMean(event){
                if(event.target === undefined)
                    return;
                for(let span of document.getElementsByClassName('reference_to_data')){
                    CheckOnVariableInSpan(span);
                }
                if(event.target.closest('.variable')){
                    const original_variable = event.target.closest('.variable');
                    let variable_in_tree = document.querySelector('.variable_in_tree[data-idVar="'+ original_variable.getAttribute('data-idVar') +'_tree"]');
                    variable_in_tree.querySelector('.variable_mean').value = event.target.value;
                }
            }

            async function onChangeVariableOriginal(event){
                const variable_in_tree = event.target.closest('.variable_in_tree');
                let original_variable = document.querySelector('.variable[data-idVar="'+ variable_in_tree.getAttribute('data-idVar').split('_tree')[0] +'"]');
                original_variable.querySelector('.variable_mean').value = event.target.value;
                original_variable.querySelector('.variable_mean').dispatchEvent(new Event('change'));
            }

            // Функция создаёт элемент переменной и добавляет в список
            function CreateNewVariable(id, name1, val1, table){
                var variableList = document.querySelector('#'+table);
                let name = name1 == undefined?'Новая переменная':name1
                let val = val1 == undefined?'':val1
                if(id)
                    variableList.insertAdjacentHTML('beforeend', 
                    `
                    <div class="variable" data-idVar="self;`+id+`" ondblclick="SelectVar(event);">
                        <input id="btn_thumbtack_self;`+id+`" onchange="FixVariable(event);" type="checkbox" class="btn-check variable_thumbtack variable_thumbtack_not_checked">
                        <label class="btn btn-labeled" for="btn_thumbtack_self;`+id+`"><i class="fa-solid fa-thumbtack"></i></label>
                        <a onclick="DeleteVariable(event);" class="btn btn-labeled variable_close"><i class="fa-solid fa-trash" style="color:red;"></i></a>
                        <span class="variable_name" contenteditable="true" oninput="onInputVariableName(event);">`+name+`</span>
                        <input class="variable_mean" onchange="onChangeVariableMean(event);" value="`+val+`">
                    </div>
                    `
                    )
                else
                    variableList.insertAdjacentHTML('beforeend', 
                    `
                    <div class="variable" data-idVar="-1" ondblclick="SelectVar(event);">
                        <input id="btn_thumbtack_self;-1" onchange="FixVariable(event);" type="checkbox" class="btn-check variable_thumbtack variable_thumbtack_not_checked" style="display:none;">
                        <label class="btn btn-labeled" style="display:none;" for="btn_thumbtack_self;-1"><i class="fa-solid fa-thumbtack"></i></label>
                        <a onclick="SaveVariable(event);" class="btn btn-labeled variable_save"><i class="fa-solid fa-check" style="color:green;"></i></a>
                        <a onclick="DeleteVariable(event);" class="btn btn-labeled variable_close"><i class="fa-solid fa-trash" style="color:red;"></i></a>
                        <span class="variable_name" contenteditable="true" oninput="onInputVariableName(event);">`+name+`</span>
                        <input class="variable_mean" value="`+val+`">
                    </div>
                    `
                    )
                
                UpdateVariableList();
            }

            // Функция сохраняет переменную в базу данных
            function SaveVariable(evt){
                let variable = evt.target.closest('.variable')
                $.ajax({
                    type: "POST",
                    url: "/document/variable/create",
                    data: JSON.stringify(VariableToJSON(variable)),
                    contentType: "application/json; charset=utf-8",
                    success: function(res, status, xhr){
                        switch (xhr.status){
                            case 200:
                                variable.setAttribute('data-idVar', 'self;'+xhr.getResponseHeader('id'));
                                variable.style.backgroundColor = "white";
                                variable.querySelector('.variable_thumbtack').style.display = '';
                                variable.querySelector('.variable_thumbtack').id = 'btn_thumbtack_self;'+xhr.getResponseHeader('id');
                                variable.querySelector('.variable_thumbtack + label').style.display = '';
                                variable.querySelector('.variable_thumbtack + label').setAttribute('for', 'btn_thumbtack_self;'+xhr.getResponseHeader('id'))
                                variable.querySelector('.variable_save').style.display = 'none'
                                SetDefaultVariable(variable)
                                break;
                            case 304:
                                variable.style.backgroundColor = "red";
                                TextOfError.textContent = decodeURIComponent(escape(xhr.getResponseHeader('MessageOfError')));
                                TypeOfError.textContent = decodeURIComponent(escape(xhr.getResponseHeader('TypeOfError')));
                                errorModal.toggle();
                                break;
                        }
                    }
                });
            }

            // Функция сохраняет сохранённые элементы в базу данных
            function SaveSavedElement(list_elem){
                $.ajax({
                    type: "POST",
                    url: "/document/savedelement/create",
                    data: JSON.stringify(SavedElementToJSON(list_elem, 0)),
                    contentType: "application/json; charset=utf-8",
                    success: function(res, status, xhr){
                        list_elem.setAttribute('data-idDB', xhr.getResponseHeader('id'));

                    }
                });
            }

            // Функция запускает сохранения элементов в базу данных
            function SaveListSaved(){
                try {
                    for(let list_elem of list_saved_sp.children)
                        SaveSavedElement(list_elem);
                    return true;  
                } catch (error) {
                    return false;
                }
            }

            // Функция сохраняет все переменные из таблицы
            function SaveVariables(){
                try {
                    for(let variable of document.getElementsByClassName('variable')){
                        SaveVariable(variable);
                    }
                    return true;
                } catch (error) {
                    return false;
                }
                
            }

            function onClearEventCallerIdBtnClick(){
                document.getElementById('EventCallerID').innerHTML='';
                document.getElementById('btnAddReceiver').classList.add('invisible')
                let sender = document.getElementById('EventCallerID').value
                FillReceivers(sender)
                for(let elem of document.querySelectorAll('.hovered_event_caller')){
                    elem.classList.remove('hovered_event_caller')
                }
                for(let elem of document.querySelectorAll('.selected_event_caller')){
                    elem.classList.remove('selected_event_caller')
                }
            }

            function EventCallerChanged(){
                let caller = document.getElementById('EventCallerID')
                if(caller.value === null || caller.value === undefined)
                    return;
                let btn = document.getElementById('btnAddReceiver')
                btn.classList.remove('invisible')
                var element = document.getElementById(caller.value);
                FillReceivers(element.id)
            }

            // function EventChanged(){
            //     var element = document.querySelector('#'+document.querySelector('#EventCallerID').value);
            //     FillReceivers(element.id, EventType.value)
            // }

            function FillReceivers(sender=null){
                EventReceiversList.innerHTML = "";
                var receivers = eventManager.getReceivers(sender)
                for(let receiver of receivers){
                    for(let event of receiver.events){
                        console.log(receiver)
                        let receiver_element = document.getElementById(event.receiver)
                        let sender_element = document.getElementById(receiver.sender)
                        if(receiver_element === null || receiver_element === undefined || sender_element === undefined || sender_element === null){
                            eventManager.deleteEventListener(event.id)
                            continue
                        }
                        let rec = AddEventReceiver(receiver_element, sender_element, event.event.type, event.operation, false, event.id, event.event.uslovie);
                        for(let elem of rec.querySelectorAll('select, input')){
                            console.log(elem)
                            elem.setAttribute('disabled', true);
                        }
                    } 
                }
            }

            //Функция добавления элемента в радиогруппу
            // function ElementInRadioGroup(id_element, id_radioGroup){ 
            //     var element = document.querySelector('.tree_element[data-idElement="'+ id_element +'"]');
            //     var radioGroup = document.querySelector('#'+id_radioGroup);
            //     element.querySelector('input').type = 'radio';
            //     element.querySelector('input').name = id_radioGroup;
            //     element.style.backgroundColor = radioGroup.previousElementSibling.lastElementChild.value;
            // }

            // Функция удаления элемента из радиогруппы
            // function ElementDeleteFromRadioGroup(id_element){
            //     var element = document.querySelector('.tree_element[data-idElement="'+ id_element +'"]');
            //     element.querySelector('input').type = 'checkbox';
            //     element.querySelector('input').name = '';
            //     element.style.backgroundColor = element.parentNode.style.backgroundColor;
            // }

            function AddDependence(evt){
                var sender = EventCallerID.value;
                var receiverContainer = evt.target.closest('.EventReceiver');
                let id = receiverContainer.getAttribute('data-idDependence')
                if(!sender && !id){
                    alert('Невозможно добавить зависимость. Не выбран отправитель')
                    return
                }
                
                var operation = receiverContainer.querySelector('.EventReceiverDoing').value
                var event = receiverContainer.querySelector('.EventType').value
                let usl = receiverContainer.querySelector('.EventTypeUslovie').value
                if(id === undefined || id === null || id === ''){
                    id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                    eventManager.addEventListener(event, operation, sender, receiverContainer.getAttribute('data-idElement'), id, usl);
                    console.log('Добавлено')
                }
                else{
                    eventManager.updateEventListener(id, event, operation, receiverContainer.getAttribute('data-idElement'), usl);
                    console.log('Обновлено')
                }
                receiverContainer.querySelector('.btnChangeReceiver').classList.remove('invisible')
                receiverContainer.querySelector('.btnApproveReceiver').classList.add('invisible');
                for(let elem of receiverContainer.querySelectorAll('select, input')){
                    elem.setAttribute('disabled', true);
                }
                receiverContainer.setAttribute('data-idDependence', id)
            }

            function DeleteDependence(evt){
                var receiverContainer = evt.target.closest('.EventReceiver');
                let id = receiverContainer.getAttribute('data-idDependence')
                console.log(id)
                if(id === undefined || id === null || id === '')
                    receiverContainer.parentElement.removeChild(receiverContainer)
                let deleted = eventManager.deleteEventListener(id)
                if(deleted)
                    receiverContainer.parentElement.removeChild(receiverContainer)
            }

            function ChangeDependence(evt){
                var receiverContainer = evt.target.closest('.EventReceiver');
                receiverContainer.querySelector('.btnApproveReceiver').classList.remove('invisible')
                receiverContainer.querySelector('.btnChangeReceiver').classList.add('invisible');
                for(let elem of receiverContainer.querySelectorAll('select, input')){
                    elem.removeAttribute('disabled');
                }
            }

            function closeModal(evt){
                let elem = evt.target.closest('.modal-backdrop')
                let modal = document.getElementById('document_main')
                elem.parentElement.removeChild(elem);
                modal.classList.remove('get_event_receiver')
            }

            function PopoverAddEventReceiver(){
                let modal = document.getElementById('document_main')
                let overlay = document.querySelector('#overlay-modal')
                let body = document.querySelector('body')
                modal.classList.add('get_event_receiver')
                body.insertAdjacentHTML('beforeend', `
                    <div class="modal-backdrop show" onclick="closeModal(event)"></div>
                `)
            }

            function mouseOverReceiverContainer(evt){
                let id = evt.target.closest('.EventReceiver').getAttribute('data-idElement')
                if(id === undefined || id === null || id === '')
                    return;
                let element = document.getElementById(id)
                if(element === null || element === undefined)
                    return;
                element.classList.add('hovered_dependence');
                let id_sender = evt.target.closest('.EventReceiver').getAttribute('data-idSender')
                if(id_sender === undefined || id_sender === null || id_sender === '')
                    return;
                let sender = document.getElementById(id_sender)
                if(sender === null || sender === undefined)
                    return;
                sender.classList.add('hovered_event_caller');
            }

            function mouseOutReceiverContainer(evt){
                let id = evt.target.closest('.EventReceiver').getAttribute('data-idElement')
                if(id === undefined || id === null || id === '')
                    return;
                let element = document.getElementById(id)
                if(element === null || element === undefined)
                    return;
                element.classList.remove('hovered_dependence');
                let id_sender = evt.target.closest('.EventReceiver').getAttribute('data-idSender')
                if(id_sender === undefined || id_sender === null || id_sender === '')
                    return;
                let sender = document.getElementById(id_sender)
                if(sender === null || sender === undefined)
                    return;
                sender.classList.remove('hovered_event_caller');
            }

            function event_type_changed(evt){
                let event_type = evt.target.closest('.EventType')
                let parent = event_type.parentNode;
                console.log(event_type.value)
                if(event_type.value == 'find' || event_type.value == 'unfind'){
                    parent.querySelector('.EventTypeUslovie').classList.remove('invisible')
                }
                else{
                    parent.querySelector('.EventTypeUslovie').classList.add('invisible')
                }
            }

            function getTextFromParagraph(paragraph){
                if(paragraph === null || paragraph === undefined || !paragraph.classList.contains('paragraph'))
                    return
                text = ""
                for(let run of paragraph.querySelectorAll('.runs')){
                    text += run.textContent + " "
                }
                return text.trim()
            }

            function AddEventReceiver(element, sender, event_type, operation, is_new, id='', usl=''){
                if(element === null || element === undefined)
                    return
                if(sender === null || sender === undefined)
                    return
                let elem_type = ""
                let send_type = ""
                let btn_add_invis = !is_new?'invisible':''
                let btn_red_invis = is_new?'invisible':''
                if(element.classList.contains('runs'))
                    elem_type = "Текст"
                else if(element.classList.contains('paragraph'))
                    elem_type = "Параграф"
                if(sender.classList.contains('runs'))
                    send_type = "Текст"
                else if(sender.classList.contains('paragraph'))
                    send_type = "Параграф"
                document.querySelector('#EventReceiversList').insertAdjacentHTML('beforeend',
                `
                <div class="EventReceiver row ms-3 me-3" data-idElement="`+ element.id +`" data-idSender="`+ sender.id +`" data-idDependence="`+id+`" onmouseover="mouseOverReceiverContainer(event);" onmouseout="mouseOutReceiverContainer(event);">
                    <div class="d-flex flex-column col-10">
                        <div class="EventReceiverIDContainer row mb-3">
                            <span class="col">Отправитель: `+ send_type +` `+ sender.id +` `+ sender.getAttribute('data-name') +`</span>
                        </div>
                        <div class="EventReceiverIDContainer row mb-3">
                            <span class="col">Получатель: `+ elem_type +` `+ element.id +` `+ element.getAttribute('data-name') +`</span>
                        </div>
                        <div class="EventReceiverIfContainer row mb-3">
                            <span class="col">Событие отправителя:</span>
                            <select class="EventType form-select col" onchange="event_type_changed(event)">
                                <option value="hidden">Спрятался</option>
                                <option value="unhidden">Появился</option>
                                <option value="find">Текст содержит</option>
                                <option value="unfind">Текст не содержит</option>
                            </select>
                            <input type="text" class="form-control invisible EventTypeUslovie mt-2" value="`+usl+`">
                        </div>
                        <div class="EventReceiverDoingContainer row mb-3">
                            <span class="col">Действие:</span>
                            <select class="EventReceiverDoing form-select col">
                                <option value="hide">Спрятать</option>
                                <option value="unhide">Показать</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex flex-column col-1">
                        <a type="button" class="btn btn-labeled btnApproveReceiver `+ btn_add_invis +`" onclick="AddDependence(event);"><i class="fa-solid fa-check" style="color:green"></i></a>
                        <a type="button" class="btn btn-labeled btnChangeReceiver `+ btn_red_invis +`" onclick="ChangeDependence(event);"><i class="fa-solid fa-pen"></i></a>
                        <a type="button" class="btn btn-labeled btnDeleteReceiver" onclick="DeleteDependence(event);"><i class="fa-solid fa-trash" style="color:red"></i></a>
                    </div>
                </div>
                `)
                var receiver = document.querySelector('#EventReceiversList > .EventReceiver:last-child');
                //FillSelectFromArrayOfElements(receiver.querySelector('.EventReceiverID'), document_main.querySelectorAll('.docelement'))
                //setEventSelect(receiver.querySelector('.EventReceiverID'), element)
                receiver.querySelector('.EventReceiverDoing').value = operation;
                receiver.querySelector('.EventType').value = event_type;
                receiver.querySelector('.EventType').dispatchEvent(new Event('change'))
                return receiver;
            }

            function FillSelectFromArrayOfElements(select, elements){
                select.innerHTML = "";
                for(let element of elements){
                    select.insertAdjacentHTML('beforeend', 
                    `
                        <option value="` + element.id + `">`+element.id + `: ` + element.getAttribute('data-name') +`</option>
                    `)
                }
            }

            function ContextFilterClicked(cattle, filter){
                if(cattle == 'delFilters')
                    filterManager.deleteFilter(tempElement.id, filter)
                else
                    filterManager.addFilter(tempElement.id, filter, cattle)
            }

            function radioButtonFilterChanged(evt){
                let filter = evt.target.closest('.filter_radio');
                let element = document.querySelector('.selectedRun');
                if (element === null || element === undefined)
                    return
                switch (filter.name) {
                    case 'filterCattle':
                        filterManager.addFilter(element.id, 'ChangeCattle', filter.value)
                        break;
                    case 'filterCase':
                        filterManager.addFilter(element.id, 'ChangeCase', filter.value)
                        break;
                    case 'filterRascrit':
                        filterManager.addFilter(element.id, 'Raskrit', filter.value)
                        break;
                    default:
                        break;
                }
            }

            function ConnectNewObject(evt){
                let csrf_token = document.querySelector('meta[name="csrf_token"]').getAttribute('content')
                fetch('/database/get_objects_to_connect/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token
                },
                body: JSON.stringify({
                })
                })
                .then(response => response.json())
                .then(data => {
                    let select = $('#objectSelect');
                    if (select.is('.select2-hidden-accessible')) {
                        select.select2('destroy');
                    } // Разрушить select2 объект
                    select.empty(); // Очистить список
                    data.object.forEach(obj => {
                        let option = new Option(obj.name, obj.id, false, false);
                        select.append(option).trigger('change');
                    });
                    select.select2({
                        width: '100%', // ширина select2
                        dropdownParent: $('#modal_objectConnectModal_body'),
                        multiple: true,
                    });
                    $('#objectConnectModal').modal('show');
                })
                .catch(error => console.error(error));
            }

            function deleteObjectFromDocument(id){
                if(!confirm('Вы точно хотите отвязать объект от документа?'))
                    return;
                let form_data = new FormData()
                let csrf_token = document.querySelector('meta[name="csrf_token"]').getAttribute('content')
                let doc_id = document.querySelector('meta[name="doc_id"]').getAttribute('content')
                form_data.append('object_id', id)
                
                fetch('/document/delete_object_from_document/'+doc_id + '/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrf_token
                    },
                    body: form_data
                })
                .then(response => {
                    console.log(response);
                    alert('Успешно удалено! Пока не доделал удаление в реальном времени, нужно сохранить документ и перезагрузить страницу')
                    //todo: Дописать удаление объекта
                })
                .catch(error => alert(error));
            }

            function addObjects() {
                let select = document.getElementById('objectSelect');
                let selectedObjects = Array.from(select.selectedOptions).map(option => option.value);
                let doc_id = document.querySelector('meta[name="doc_id"]').getAttribute('content')
                let csrf_token = document.querySelector('meta[name="csrf_token"]').getAttribute('content')
                let form_data = new FormData()
                for (let i = 0; i < selectedObjects.length; i++) {
                    form_data.append('selectedObjects[]', selectedObjects[i])
                }
                fetch('/document/connect_objects_to_document/'+doc_id + '/' , {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrf_token
                    },
                    body: form_data
                })
                    .then(response => {
                        console.log(response);
                        $('#objectConnectModal').modal('hide');
                        alert('Успешно удалено! Пока не доделал добавление в реальном времени, нужно сохранить документ и перезагрузить страницу')
                        //todo: Дописать добавление объекта
                    })
                    .catch(error => console.error(error));
            }

            function getDataFromObject(obj_id, form){
                let csrf_token = document.querySelector('meta[name="csrf_token"]').getAttribute('content')
                fetch('/database/get_data_from_object/'+obj_id+'/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrf_token
                    },
                    body: new FormData(form),
                })
                .then(response => response.text())
                .then(columns =>{
                    data = JSON.parse(columns)[0];
                    for(let [key, value] of Object.entries(data)){
                        let object_parameter = document.querySelector('.obj_parameter[data-idParam="'+key+'"]')
                        data_type = value['data_type']
                        data_value = value['value']
                        if(data_value == 'nan')
                            data_value = ''
                        if(data_type == 'TXT' || data_type == 'TXTS' || data_type == 'DATE'){
                            let inp = object_parameter.querySelector('input[name="'+key+'"]')
                            inp.value = data_value
                            inp.dispatchEvent(new Event('change'))
                        }
                        else if(data_type == 'ARRAY'){
                            let container = object_parameter.querySelector('.array_data_container')
                            container.innerHTML = ''
                            for(let i = 0; i < data_value.length; i++){
                                container.insertAdjacentHTML('beforeend', `
                                    <div class="array_data">
                                        <span>
                                            `+ data_value[i] +`    
                                        </span>
                                    </div>
                                `)
                            }
                        }
                        // else if(data_type == 'DATE'){
                        //     let inp = form.querySelector('input[name="'+key+'"]') 
                        //     inp.value = data_value;
                        //     inp.dispatchEvent(new Event('change'))
                        // }
                    }
                    $('#objectFindDataModal').modal('hide');
                    
                })
                .catch(error => console.error(error));
            }

            function click_to_ident(evt, object_id, value, param_ident_id){
                let object = document.querySelector('#object_'+object_id)
                let input = object.querySelector('input.identificator')
                let input_fast = document.querySelector('.obj_parameter_fast[data-idObj="'+object_id+'"]')
                let input_id_to_connect = object.querySelector('input[name="param_ident_id"]')
                input.value = value
                input_id_to_connect.value = param_ident_id
                console.log(input_fast)
                console.log(input_fast.innerHTML)
                if(input_fast !== null && input_fast !== undefined)
                    input_fast.querySelector('input').value = value
                input.dispatchEvent(new Event('change'))
                getDataFromObject(object_id, object.querySelector('form'))
            }

            function openFindDataModal(data, obj_id){
                let container = document.querySelector('.objectFindDataModalContainer')
                let name = document.querySelector('#objectFindDataModalName')
                let datalist = document.getElementById('idents_list')
                name.innerHTML = data.object.name
                container.innerHTML = ""
                for(let ident of data.idents){
                    container.insertAdjacentHTML('beforeend', `
                        <div class="ident col" onclick="click_to_ident(event, '${obj_id}', '${ident.param_ident}', '${ident.id}')">
                            <span>`+ident.param_ident+`<span>
                        </div>
                    `)
                    datalist.insertAdjacentHTML('beforeend', `
                        <option value="`+ident.param_ident+`"></option>
                    `)
                }
                $('#objectFindDataModal').modal('show');
            }

            function onFilterInputInput(evt){
                let filterInput = evt.target
                let identElements = document.querySelectorAll('.ident');
                const filterValue = filterInput.value.toLowerCase();
                identElements.forEach((element) => {
                    const textContent = element.textContent.toLowerCase();
                    if (textContent.includes(filterValue)) {
                        element.style.display = 'block';
                    } else {
                        element.style.display = 'none';
                    }
                });
            }

            function getObjectData(evt, object_id){
                let input = evt.target.closest('input');
                let form_data = new FormData();
                let csrf_token = document.querySelector('meta[name="csrf_token"]').getAttribute('content')
                fetch('/database/get_object/'+object_id + '/' , {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrf_token
                    },
                    body: form_data
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    openFindDataModal(data, object_id)
                })
                .catch(error => console.error(error));
            }

            function FillEvents(){
                let sender = document.getElementById('EventCallerID').value
                FillReceivers(sender)
            }

            function getPreviousElementParagraph(parent) {
                const previousElement = parent.previousElementSibling;

                if (!previousElement || !previousElement.classList.contains('docelement')) {
                    return element;
                }
                if (previousElement.hidden) {
                    let elem = getPreviousElementParagraph(previousElement);
                    if(previousElement === elem)
                        return element
                    else
                        return elem
                }
                if (previousElement.querySelector('.docelement:not([hidden]):last-child'))
                    return previousElement.querySelector('.docelement:not([hidden]):last-child');
                else
                    return getPreviousElementParagraph(previousElement);
            }

            function getNextElementParagraph(parent) {
                const nextElement = parent.nextElementSibling;

                if (!nextElement || !nextElement.classList.contains('docelement')) {
                    return element;
                }
                if (nextElement.hidden) {
                    let elem = getNextElementParagraph(nextElement);
                    if(nextElement === elem)
                        return element
                    else
                        return elem
                }
                if (nextElement.querySelector('.docelement:not([hidden])'))
                    return nextElement.querySelector('.docelement:not([hidden])');
                else
                    return getNextElementParagraph(nextElement);
            }

            function getPreviousElementRun(element) {
                const previousElement = element.previousElementSibling;
                if (!previousElement || !previousElement.classList.contains('docelement')) {
                    return getPreviousElementParagraph(element.parentElement);
                }
                if (previousElement.hidden) {
                    let elem = getPreviousElementRun(previousElement);
                    if(previousElement === elem)
                        return element
                    else
                        return elem
                }
                return previousElement;
            }
            

            function getNextElementRun(element) {
                const nextElement = element.nextElementSibling;
                if (!nextElement ||!nextElement.classList.contains('docelement')) {
                    return getNextElementParagraph(element.parentElement);
                }
                if (nextElement.hidden) {
                    let elem = getNextElementRun(nextElement);
                    if(nextElement === elem)
                    return element
                    else
                    return elem
                }
                return nextElement;
            }


            class EventManager{
                constructor(){
                    this.eventHashTable = {}
                    this.events = ['hidden', 'unhidden']
                    this.operations = ['hide', 'unhide']
                    this.reverseOperations = {'hide':'unhide', 'unhide':'hide'}           
                }

                getEvents(){
                    const allEvents = [];
                    for(const [sender, value] of Object.entries(this.eventHashTable)){
                        for(const event of value['events']){
                            allEvents.push({'sender': sender, 'id': event.id, 'event': event});
                        }
                    }
                    return allEvents;
                }

                getReceivers(sender=null){
                    if(this.eventHashTable[sender] === undefined || this.eventHashTable[sender] === null){
                        if(sender !== null && sender !== undefined && sender !== '') 
                            return []
                        const allEvents = [];
                        for(const sender in this.eventHashTable){
                            allEvents.push({'sender': sender, 'events': this.eventHashTable[sender]['events']});
                        }
                        return allEvents;
                    }
                    return [{'sender': sender, 'events': this.eventHashTable[sender]['events']}];
                }

                findEventsByReceiver(receiver){
                    const allEvents = [];
                    for(const [sender, value] of Object.entries(this.eventHashTable)){
                        for(const event of value['events']){
                            if(event.receiver == receiver)
                                allEvents.push({'sender': sender, 'id': event.id, 'event': event});
                        }
                    }
                    return allEvents
                }

                findEventsBySender(sender){
                    if(this.eventHashTable[sender] === undefined || this.eventHashTable[sender] === null)
                        return []
                    const allEvents = [];
                    for(let event of this.eventHashTable[sender]['events']){
                        allEvents.push({'sender': sender, 'id': event.id, 'event': event});
                    }
                    return allEvents
                }

                findEventListenerById(id) {
                    const events = this.getEvents();
                    const event = events.find((event) => event.id === id);
                    return event;
                }

                addEventListener(event, operation, sender, receiver, id, uslovie='') {
                    if(!this.eventHashTable[sender]){
                        this.eventHashTable[sender] = {'events': []};
                    }
                    // if(this.findEventByReceiver(event, operation, sender, receiver, uslovie))
                    //     return false;
                    this.eventHashTable[sender]['events'].push({'id': id, 'event': {'type': event, 'uslovie': uslovie},'operation': operation, 'receiver': receiver});
                    console.log(this.eventHashTable)
                    return true;
                }

                updateEventListener(id, event, operation, receiver, uslovie = '') {
                    const sender = this.findEventListenerById(id)?.sender;
                    if (!sender) {
                        console.error('Event not found with id', id);
                        return false;
                    }
                    const eventIndex = this.eventHashTable[sender]['events'].findIndex((event) => event.id === id);
                    if (eventIndex === -1) {
                        console.error('Event not found with id', id);
                        return false;
                    }
                    this.eventHashTable[sender]['events'][eventIndex] = {
                        'id': id,
                        'event': {
                            'type': event,
                            'uslovie': uslovie
                        },
                        'operation': operation,
                        'receiver': receiver
                    };
                    return true;
                }

                deleteEventListener(id) {
                    for (const sender in this.eventHashTable) {
                        const events = this.eventHashTable[sender]['events'];
                        const index = events.findIndex((ev) => ev.id == id);
                        if (index !== -1) {
                            events.splice(index, 1);
                            return true;
                        }
                    }
                    return false;
                }

                switchOperation(operation, receiver){
                    switch (operation) {
                        case 'hide':
                            var element = document.querySelector('.tree_element[data-idElement="'+ receiver +'"] .hideCheckbox');
                            if(element.checked == true){
                                element.checked = false;
                                element.dispatchEvent(new Event('change'));
                            }
                            break;
                        case 'unhide':
                            var element = document.querySelector('.tree_element[data-idElement="'+ receiver +'"] .hideCheckbox');
                            if(element.checked == false){
                                element.checked = true;
                                element.dispatchEvent(new Event('change'));
                            }
                            break;
                        default:
                            break;
                    }
                }

                async dispatchNotCalledEvent(){
                    for (const sender in this.eventHashTable) {
                        const events = this.eventHashTable[sender]['events'];
                        let sender_element = document.getElementById(sender)
                        if(sender_element == null || sender_element == undefined)
                            continue
                        for(let event of events){
                            if(String(event.event.type).indexOf('find') == -1)
                                continue
                            let uslovie = event.event.uslovie
                            let receiver = event.receiver
                            let operation = event.operation
                            let sender_text = ""
                            if(sender_element.classList.contains('runs'))
                                sender_text = sender_element.textContent
                            else if(sender_element.classList.contains('paragraph'))
                                sender_text = getTextFromParagraph(sender_element)
                            switch (event.event.type) {
                                case 'find':
                                    if(sender_text.includes(uslovie)){
                                        this.switchOperation(operation, receiver)
                                    }
                                    // else{
                                    //     this.switchOperation(this.reverseOperations[operation], receiver)
                                    // }
                                    break;
                                case 'unfind':
                                    if(!sender_text.includes(uslovie)){
                                        this.switchOperation(operation, receiver)
                                    }
                                    // else{
                                    //     this.switchOperation(this.reverseOperations[operation], receiver)
                                    // }
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                }

                async eventDispatch(sender, event){
                    if(this.eventHashTable[sender] === undefined || this.eventHashTable[sender] === null)
                        return;
                    for(let receiver of this.eventHashTable[sender]['events']){
                        try {
                            if(receiver.event.type !== event)
                                continue
                            this.switchOperation(receiver.operation, receiver.receiver)
                        } catch (error) {
                            console.log(error)
                            continue
                        }
                    }
                }
            }

            function getDataFromReference(element){
                if(!element.classList.contains('reference_to_data'))
                    return
                if(element.classList.contains('variable_ref')){
                    let ref = document.querySelector('.variable[data-idVar="'+ element.getAttribute('data-idVar') +'"]')
                    if(ref === undefined || ref === null)
                        return element.textContent
                    let val = ref.querySelector('.variable_mean')
                    if(val.type == "text")
                        return val.value;
                    else if(val.type == "date"){
                        return new Date(val.value).toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: 'long',
                            year: 'numeric',
                            }).replace('г.', 'года');
                    }
                }
                if(element.classList.contains('object_param_ref')){
                    let ref = document.querySelector('.obj_parameter[data-idParam="'+ element.getAttribute('data-idObjParam') +'"]')
                    if(ref === undefined || ref === null)
                        return element.textContent
                    let val = ref.querySelector('.obj_parameter_value')
                    if (val.classList.contains('array_data_container'))
                        return getDataFromObjectArray(val)
                    else if(val.type == "text")
                        return val.value;
                    else if(val.type == "date"){
                        return new Date(val.value).toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: 'long',
                            year: 'numeric',
                            });
                    }
                }
            }

            function setDateToday(){
                let DateTodayVariable = document.querySelector('div[data-idVar="system;date_today"] .variable_mean')
                DateTodayVariable.value = new Date().toISOString().split('T')[0]
                for(let span of document.querySelectorAll('.runs[data-idVar="system;date_today"]')){
                    CheckOnVariableInSpan(span);
                }
            }

            class FilterManager{
                constructor(){
                    this.FilterHashTable = {}
                    this.filters = ['ChangeCase', 'UpperCase', 'Raskrit']
                    this.cattles = {'Именительный':'nomn', 'Родительный':'gent', 'Дательный': 'datv', 'Винительный':'accs', 'Творительный':'ablt', 'Предложный':'loct'}               
                }

                addFilter(textElement, filter, cattle){
                    if(cattle == 'delFilters')
                        this.deleteFilter(textElement, filter)
                    if(this.FilterHashTable[textElement])
                        this.FilterHashTable[textElement][filter] = cattle
                    else{
                        this.FilterHashTable[textElement] = {}
                        this.FilterHashTable[textElement][filter] = cattle
                    }
                }

                acceptAllFilters(){
                    return new Promise((resolve, reject) => {
                        let dataBig = {}
                        for(let[key, value] of Object.entries(filterManager.FilterHashTable)){
                            let dataSmall = {}
                            let element = document.getElementById(key)
                            if(element === undefined || element === null){
                                delete this.FilterHashTable[key]
                                continue
                            }
                            for(let [fil, val] of Object.entries(value)){
                                if(val === 'delFilters'){
                                    this.deleteFilter(key, fil)
                                    continue
                                } 
                            }
                            dataSmall['filters'] = value
                            if(!element.classList.contains('reference_to_data'))
                                dataSmall['phrase'] = element.getAttribute('data-invis')
                            else
                                dataSmall['phrase'] = getDataFromReference(element)
                            dataBig[key] = dataSmall
                        }
                        fetch('/document/acceptFilters', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json; charset=utf-8'
                            },
                            body: JSON.stringify(dataBig)
                        }).then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                throw new Error('HTTP error ' + response.status);
                            }
                        }).then(data => {
                            for (let [key, value] of Object.entries(data)) {
                                if (String(value).length > 0) {
                                    document.getElementById(key).textContent = value;
                                }
                            }
                            resolve();
                        }).catch(error => {
                            reject(error);
                        });
                    });
                }

                deleteFilter(element, filter){
                    try {
                        delete this.FilterHashTable[element][filter]
                        return true
                    } catch (error) {
                        return false
                    }
                }

                fromJSON(json_stroke){
                    var jsonp = JSON.parse(json_stroke);
                    if('filters' in jsonp){
                        this.FilterHashTable = jsonp['filters']
                    }
                }

            }

            class CycleManager{
                constructor(){
                    this.CycleHashTable = {}
                }

                addCycle(docElement_id, object_array_idParam){
                    this.CycleHashTable[docElement.id] = {"element": docElement_id, "object_array": object_array_idParam}
                }

                deleteCycle(docElement){
                    try {
                        delete this.CycleHashTable[docElement.id]
                        return true
                    } catch (error) {
                        return false
                    }
                }

                acceptCycle(docelement_id){
                    let cycle = this.CycleHashTable[docelement_id]
                    let element = cycle['element']
                    let object_array = cycle['object_array']
                    let copy_element = element.cloneNode(true);
                    let i = 1
                    copy_element.id = 'copy_' + element.id + '_' + i
                    copy_element.classList.add('docelement_copy')
                    element.parentElement.insertBefore(copy_element, element.nextElementSibling);
                }

                acceptAllCycles(){
                    
                }

                fromJSON(json_stroke){
                    var jsonp = JSON.parse(json_stroke);
                    if('cycles' in jsonp){
                        this.CycleHashTable = jsonp['cycles']
                    }
                }

            }
            
            // Стартовые значения
            var startFontSize = 12;
            var startInterval = 1;
            var startIndent = 0;
            var startFont = "Times New Roman"
            //Объявляем переменные
            var lastVersions = new Stack();
            var redSpan = undefined;
            var list_save = [];
            let anchors_runs = {

            }

            var errorModal = new bootstrap.Modal(document.getElementById('errorWindowModal'), {
                keyboard: false
            })
            var imageLoadModal = new bootstrap.Modal(document.getElementById('imageLoadModal'), {
                keyboard: false
            })
            // var variableModal = new bootstrap.Modal(document.getElementById('variableModal'), {
            //     keyboard: false
            // })
            
            // var eventModal = new bootstrap.Modal(document.getElementById('eventModal'), {
            //     keyboard: false
            // })

            var eventManager = new EventManager();

            var filterManager = new FilterManager();

            var cycleManager = new CycleManager();

            var tempElement;

            DocFromJSON("{{ document_json|escapejs }}")
            
            filterManager.fromJSON("{{ document_json|escapejs }}")
            cycleManager.fromJSON("{{ document_json|escapejs }}")

            VariableFromJSON("{{ variable|escapejs }}")
            setDateToday();
            
            FixedVariablesFromJSON("{{ document_json|escapejs }}")

            SetDefault();

            SaveLastVersion();

            switchAdminMode(false);

            FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));

            RadioGroupsFromJSON("{{ document_json|escapejs }}");

            FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));

            UpdateVariableList();

            FillReceivers()

            onChangeVariableMean('');
            
            // if('{{ vks }}' == 'True')
                //  AutoFillFromRequest("{{ data|escapejs }}")

            $(document).ready(function () {

                for(let element of document_main.querySelectorAll('.docelement')){
                    //var tree_element = document.querySelector('.tree_element[data-idElement="'+ child.id +'"]')
                    if(!element.getAttribute('data-idRadioGroup'))
                        continue;
                    if(element.getAttribute('data-idRadioGroup') == "radioGroup-1")
                        continue
                        //unsetRadio(element, document.getElementById(element.getAttribute('data-idRadioGroup')))
                    setRadio(element, document.getElementById(element.getAttribute('data-idRadioGroup')))
                }
                FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));

                

            // Обработчик нажатия на кнопку сохранения
            document.getElementById("updateButton").onclick = function(evt){
                UpdateFile();
            }

            // Создание обработчиков события для всех кнопок удаления элементов
            for(let btn of document.querySelectorAll('.deleteButton')){
                btn.onclick = function(){
                    SaveLastVersion();
                    if(document.querySelector('.selectedRun')){
                        DeleteRun(document.querySelector('.selectedRun'));
                    }
                    else
                        return;
                }
            }

            
            // Обработчик нажатий на клавиши. Горячие клавиши при наборе текста.
            document.addEventListener('keydown', async function(event){
                if(!event.target.classList.contains('docelement') &&  (!redSpan || !redSpan.classList.contains('imageDocElement')))
                    return
                var selectedRun = document.querySelector('.selectedRun');
                switch(event.keyCode){
                    case 8: // Нажатие на Backspace. Стирание текста, удаление элемента, если пустой. 
                    event.stopPropagation();
                        if(!redSpan)
                            return;
                        SaveLastVersion();
                        if(redSpan.textContent.length == 0){
                            await DeleteElement(redSpan);
                        }
                        break;
                    case 9: // Нажатие на Tab. Добавление нового текстового элемента
                        event.preventDefault();
                        event.stopPropagation();
                        if(!redSpan)
                            return;
                        SaveLastVersion();
                        if(!redSpan.classList.contains('reference_to_data'))
                            redSpan.setAttribute('data-invis', redSpan.textContent);
                        redSpan.contentEditable = false;
                        let run = AddRunAfter(redSpan);
                        break;
                    case 13: // Нажатие на Enter. Добавление нового параграфа
                        event.preventDefault();
                        event.stopPropagation();
                        if(redSpan == undefined)
                            return;
                        SaveLastVersion();
                        if(!redSpan.classList.contains('reference_to_data'))
                            redSpan.setAttribute('data-invis', redSpan.textContent);
                        if(redSpan.classList.contains('reference_to_data')){
                            setEndOfContenteditable(redSpan)
                        }
                        var indexStart = getCaretPosition(redSpan);
                        var run_splitted = [redSpan.textContent.substring(0, indexStart), redSpan.textContent.substring(indexStart)];
                        
                        redSpan.textContent = run_splitted[0];
                        redSpan.setAttribute('data-invis', redSpan.textContent);
                        redSpan.contentEditable = false;
                        var newRun = await AddRunAfter(redSpan);
                        newRun.textContent = run_splitted[1];
                        newRun.setAttribute('data-invis', redSpan.textContent);
                        var runs_to_transfer = [newRun];
                        var childrens = Array.from(redSpan.parentElement.querySelectorAll('.docelement'))
                        for(let i = childrens.indexOf(redSpan) + 1; i < childrens.length; i++){
                            runs_to_transfer.push(childrens[i])
                        }
                        let parStyle = redSpan.parentElement.style.cssText;
                        let runStyle = redSpan.style.cssText;
                        let paragraph = await AddParagraphAfter(redSpan.parentElement)
                        paragraph.style.cssText = parStyle;
                        paragraph.firstElementChild.style.cssText = runStyle;
                        for(let run of runs_to_transfer){
                            var tree_elem = document.querySelector('.tree_element[data-idElement="'+ run.id +'"]')
                            tree_elem.parentElement.removeChild(tree_elem)
                            paragraph.appendChild(run);
                        }
                        FillTree(document.querySelector('#document_tree'), document_main.querySelectorAll('.paragraph'));
                        break;
                    case 37: // Нажатие на стрелочку влево. Переключиться на левый элемент
                        if (event.ctrlKey || event.metaKey) { // Зажатый Ctrl
                            event.preventDefault();
                            event.stopPropagation();
                            if(redSpan == undefined)
                                return;
                            const previousElement = getPreviousElementRun(redSpan);
                            setActiveElement(previousElement);
                        }
                        // if (event.ctrlKey || event.metaKey) { // Зажатый Ctrl
                        //     event.preventDefault();
                        //     event.stopPropagation();
                        //     if(redSpan == undefined)
                        //         return;
                        //     let previousElement = redSpan.previousElementSibling;
                        //     let parent = redSpan.parentElement;
                        //     if(!previousElement || !previousElement.classList.contains('docelement')){
                        //         let previousPar = parent.previousElementSibling;
                        //         if(!previousPar || !previousPar.classList.contains('docelement'))
                        //             return;
                        //         setActiveElement(previousPar.lastElementChild);
                        //     }
                        //     else{
                        //         if(!previousElement.classList.contains('docelement'))
                        //             return; 
                        //         setActiveElement(previousElement); 
                        //     }
                        // }
                        break;
                    case 38: // Нажатие на стрелочку вверх. Переключение на верхний параграф
                        if (event.ctrlKey || event.metaKey) { // Зажатый Ctrl
                            event.preventDefault();
                            event.stopPropagation();
                            if(redSpan == undefined)
                                return;
                            // let parent = redSpan.parentElement;
                            // let previousPar = parent.previousElementSibling;
                            // if(!previousPar || !previousPar.classList.contains('docelement'))
                            //     return;
                            setActiveElement(getPreviousElementParagraph(redSpan.parentElement));
                        }
                        break;
                    case 39: // Нажатие на стрелочку вправо. Переключение на правый элемент
                        if (event.ctrlKey || event.metaKey) { // Зажатый Ctrl
                            event.preventDefault();
                            event.stopPropagation();
                            const nextElement = getNextElementRun(redSpan);
                            setActiveElement(nextElement);
                        }
                        break;
                    case 40: // Нажатие на стрелочку вниз. Переключение на нижний параграф
                        if (event.ctrlKey || event.metaKey) { // Зажатый Ctrl
                            event.preventDefault(); 
                            event.stopPropagation();
                            if(redSpan == undefined)
                                return;
                            // let parent = redSpan.parentElement;
                            // let nextPar = parent.nextElementSibling;
                            // if(!nextPar || !nextPar.classList.contains('docelement'))
                            //     return;
                            setActiveElement(getNextElementParagraph(redSpan.parentElement));
                        }
                        break;
                    case 46: // Нажатие на Delete. Удаление элемента
                        event.preventDefault();
                        SaveLastVersion();
                        if(document.querySelector('.selectedRun'))
                            DeleteElement(document.querySelector('.selectedRun'));
                        else if(document.querySelector('.selectedImg'))
                            DeleteElement(document.querySelector('.selectedImg'));
                        else
                            return;
                        break;
                    case 81: // Нажатие на Q. Разделение элемента
                        if (event.ctrlKey || event.metaKey) { // Зажатый Ctrl
                            event.preventDefault();
                            splitRun(window.getSelection());
                        }
                        break;
                    case 90: // Нажатие на Z. Возвращение к предыдущему состоянию
                        if(event.ctrlKey || event.metaKey){ // Зажатый Ctrl
                            event.preventDefault();
                            ReturnToLastVersion();
                        }
                        break; 
                }
            });
            
            // Ставим контекстное меню
            document.oncontextmenu = ShowContextMenu;

            // Обработка нажатия на левую кнопку мыши на всей странице
            document.addEventListener('click', function(event){
                HideContextMenu();
            });

            // Нужна, чтобы работал drop ивент
            groupRadioModal.addEventListener('dragover', (evt) => {
                evt.preventDefault();
            }, false);

        
            // setInterval(
            //     () => UpdateFile(), 600000
            // );
            setInterval(
                () => {
                    eventManager.dispatchNotCalledEvent()
                }, 1000
            );
            setInterval(
                () => {
                    filterManager.acceptAllFilters();
                }, 5000
            );

            

            setInterval(()=>{
                setDateToday()
                }, 1000
            );
            // setInterval(
            //     () => {
            //         let sender = document.getElementById('EventCallerID').value
            //         FillReceivers(sender)
            //     }, 1000
            // );
        });
    </script>
</html>

